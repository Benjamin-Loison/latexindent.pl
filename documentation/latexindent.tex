% arara: pdflatex: {shell: yes}
% !arara: bibtex
% !arara: pdflatex
% !arara: pdflatex
% !arara: pdflatex
% !arara: indent: {overwrite: yes, trace: yes, localSettings: yes, silent: yes}
\documentclass[8pt]{article}
%   This program is free software: you can redistribute it and/or modify
%   it under the terms of the GNU General Public License as published by
%   the Free Software Foundation, either version 3 of the License, or
%   (at your option) any later version.
%
%   This program is distributed in the hope that it will be useful,
%   but WITHOUT ANY WARRANTY; without even the implied warranty of
%   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%   GNU General Public License for more details.
%
%   See <http://www.gnu.org/licenses/>.
\usepackage[left=4.5cm,right=2.5cm,showframe=false,
	top=2cm,bottom=1.5cm]{geometry}                      % page setup
\usepackage{lmodern}
\usepackage{parskip}                                 % paragraph skips
\usepackage{booktabs}                                % beautiful tables
\usepackage{listings}                                % nice verbatim environments
\usepackage{titlesec}                                % customize headings
\usepackage{changepage}                              % adjust width of page
\usepackage{fancyhdr}                                % headers & footers
\usepackage{wrapfig}
\usepackage[sc,format=hang,font=small]{caption}      % captions
\usepackage[backend=bibtex]{biblatex}                % bibliography
\usepackage{tcolorbox}                                % framed environments
\usepackage{xparse}
\usepackage[charter]{mathdesign}                     % changes font
\usepackage[expansion=false,kerning=true]{microtype} % better kerning
\usepackage{enumitem}                                % custom lists
% setup gitinfo2, as in the manual, details just above begin{document}
\usepackage[mark,grumpy]{gitinfo2}
% tcolorbox libraries
\tcbuselibrary{breakable,skins,listings,minted,xparse}
%\usepackage{varioref}                                % clever referencing
%\tcbuselibrary{documentation,breakable,skins,minted}
% tikz libraries
\usetikzlibrary{positioning}
\usetikzlibrary{decorations.pathmorphing}
\usetikzlibrary{decorations,shapes}
\usepackage{varioref}                                % clever referencing
\usepackage{hyperref}
\hypersetup{
	pdfauthor={Chris Hughes},
	pdftitle={latexindent.pl package},
	pdfkeywords={perl;beautify;indentation},
	bookmarksnumbered,
	bookmarksopen,
	linktocpage,
	colorlinks=true,
	linkcolor=blue,
	citecolor=black,
}
\usepackage{cleveref}

\addbibresource{latex-indent}
\addbibresource{contributors}


% http://tex.stackexchange.com/questions/122135/how-to-add-a-png-icon-on-the-right-side-of-a-tcolorbox-title
\newtcolorbox{warning}{parbox=false,breakable,enhanced,arc=0mm,colback=red!5,colframe=red,leftrule=12mm,%
overlay={\node[anchor=north west,outer sep=2pt] at (frame.north west) {\includegraphics[width=8mm]{warning}}; }}

\makeatletter
\tcbset{
	addtolol/.style={list entry={\kvtcb@title},add to list={lol}{lstlisting}},
	cmhlistings/.style={
			%	width=\linewidth,
			%breakable,
			colback=blue!5!white,
			colframe=white!85!black,
			top=0cm,
			bottom=0cm,
			left=0mm,
			listing only,
			center title,
			listing engine=minted,
			minted style=colorful,
			addtolol,
			boxrule=0pt,
			toprule=1pt,bottomrule=1pt,
			titlerule=1pt,
			colframe=white!25!black,colback=white,
			sharp corners,
			colbacktitle=white!75!black,
		},
}

\newtcblisting[use counter=lstlisting]{cmhlistings}[3][]{%
	cmhlistings,
	listing options={#1},
	center title,
	title={\color{black}{\scshape Listing \thetcbcounter}: ~#2},label={#3},
	listing engine=listings,
}

\newtcbinputlisting[use counter=lstlisting]{\cmhlistingsfromfile}[4][]{%
	cmhlistings,
	listing options={#1},
	listing file={#2},
	title={\color{black}{\scshape Listing \thetcbcounter}: ~#3},label={#4},
}

% command shell
\newtcblisting{commandshell}{colback=black,colupper=white,colframe=yellow!75!black,
	listing only,listing options={style=tcblatex,language=sh,
			morekeywords={latexindent,pl},
			keywordstyle=\color{blue!35!white}\bfseries,
		},
	listing engine=listings,
	left=0cm,
	every listing line={\textcolor{red}{\small\ttfamily\fontseries{b}\selectfont cmh:$\sim$\$ }}}


\lstset{%
	basicstyle=\small\ttfamily,language={[LaTeX]TeX},
	%	numbers=left,
	numberstyle=\ttfamily%\small,
	breaklines=true,
	%   frame=single,framexleftmargin=8mm, xleftmargin=8mm,
	%	prebreak = \raisebox{0ex}[0ex][0ex]{\ensuremath{\hookrightarrow}},
	%	backgroundcolor=\color{green!5},frameround=fttt,
	%	rulecolor=\color{blue!70!black},
	keywordstyle=\color{blue},                    % keywords
	commentstyle=\color{purple},    % comments
	tabsize=3,
	%xleftmargin=1.5em,
}%
\DeclareTCBListing[use counter=lstlisting]{yaml}{O{} m O{} m}{
	listing only,listing options={style=tcblatex,
			numbers=left,
			numberstyle=\color{red},
            #1,
		},
	listing engine=listings,
	left=0cm,
	boxrule=0pt,
	leftrule=3pt,
	sharp corners,
	center title,
	colbacktitle=white!75!black,
	title={\color{black}{\scshape Listing \thetcbcounter}: ~#2},label={#4},
    #3,
}

\lstdefinestyle{demo}{
	numbers=none,
	linewidth=1.25\textwidth,
	columns=fullflexible,
}

% stars around contributors
\pgfdeclaredecoration{stars}{initial}{
	\state{initial}[width=15pt]
	{
		\pgfmathparse{round(rnd*100)}
		\pgfsetfillcolor{yellow!\pgfmathresult!orange}
		\pgfsetstrokecolor{yellow!\pgfmathresult!red}
		\pgfnode{star}{center}{}{}{\pgfusepath{stroke,fill}}
	}
	\state{final}
	{
		\pgfpathmoveto{\pgfpointdecoratedpathlast}
	}
}

\newtcolorbox{stars}{%
enhanced jigsaw,
breakable, % allow page breaks
left=0cm,
top=0cm,
before skip=0.2cm,
boxsep=0cm,
frame style={draw=none,fill=none}, % hide the default frame
colback=white,
overlay={
\draw[inner sep=0,minimum size=rnd*15pt+2pt]
decorate[decoration={stars,segment length=2cm}] {
decorate[decoration={zigzag,segment length=2cm,amplitude=0.3cm}] {
([xshift=-.5cm,yshift=0.1cm]frame.south west) --  ([xshift=-.5cm,yshift=0.4cm]frame.north west)
}};
\draw[inner sep=0,minimum size=rnd*15pt+2pt]
decorate[decoration={stars,segment length=2cm}] {
decorate[decoration={zigzag,segment length=2cm,amplitude=0.3cm}] {
([xshift=.75cm,yshift=0.1cm]frame.south east) --  ([xshift=.75cm,yshift=0.6cm]frame.north east)
}};
},
% paragraph skips obeyed within tcolorbox
parbox=false,
}

% copied from /usr/local/texlive/2013/texmf-dist/tex/latex/biblatex/bbx/numeric.bbx
% the only modification is the \stars and \endstars
\defbibenvironment{specialbib}
{\stars\list
	{\printtext[labelnumberwidth]{%
			\printfield{prefixnumber}%
			\printfield{labelnumber}}}
	{\setlength{\labelwidth}{\labelnumberwidth}%
		\setlength{\leftmargin}{\labelwidth}%
		\setlength{\labelsep}{\biblabelsep}%
		\addtolength{\leftmargin}{\labelsep}%
		\setlength{\itemsep}{\bibitemsep}%
		\setlength{\parsep}{\bibparsep}}%
	\renewcommand*{\makelabel}[1]{\hss##1}}
{\endlist\endstars}
{\item}

\newtcbox{yamltitlebox}[1][]{colframe=black!50!white,boxrule=.5pt,sharp corners,#1}

\newcommand{\flagbox}[1]{%
    \par
	\makebox[30pt][l]{%
		\hspace{-2cm}%
		\ttfamily\fontseries{b}\selectfont #1
	}%
}

\NewDocumentCommand{\yamltitle}{O{} m s m}{%
    \par
	\makebox[30pt][l]{%
		\hspace{-2cm}%
		\yamltitlebox[#1]{%
				{\ttfamily\fontseries{b}\selectfont{\color{blue!80!white}#2}}: %
			\IfBooleanTF{#3}
			{$\langle$\itshape #4$\rangle$}
			{{\bfseries #4}}
		}}
	\par\nobreak%
}

\newcommand{\fixthis}[1]
{%
	\marginpar{\huge \color{red} \framebox{FIX}}%
	\typeout{FIXTHIS: p\thepage : #1^^J}%
}
% custom section
\titleformat{\section}
{\normalfont\Large\bfseries}
{\llap{\thesection\hskip.5cm}}
{0pt}
{}
% custom subsection
\titleformat{\subsection}
{\normalfont\bfseries}
{\llap{\thesubsection\hskip.5cm}}
{0pt}
{}
% custom subsubsection
\titleformat{\subsubsection}
{\normalfont\bfseries}
{\llap{\thesubsubsection\hskip.5cm}}
{0pt}
{}


\titlespacing\section{0pt}{12pt plus 4pt minus 2pt}{-5pt plus 2pt minus 2pt}
\titlespacing\subsection{0pt}{12pt plus 4pt minus 2pt}{-6pt plus 2pt minus 2pt}
\titlespacing\subsubsection{0pt}{12pt plus 4pt minus 2pt}{-6pt plus 2pt minus 2pt}


% cleveref settings
\crefname{table}{Table}{Tables}
\Crefname{table}{Table}{Tables}
\crefname{figure}{Figure}{Figures}
\Crefname{figure}{Figure}{Figures}
\crefname{section}{Section}{Sections}
\Crefname{section}{Section}{Sections}
\crefname{listing}{Listing}{Listings}
\Crefname{listing}{Listing}{Listings}

% headers and footers
\fancyhf{} % delete current header and footer
\fancyhead[R]{\bfseries\thepage}
\fancyheadoffset[L]{3cm}
\pagestyle{fancy}

% renew plain style
\fancypagestyle{plain}{%
	\fancyhf{} % clear all header and footer fields
	\renewcommand{\headrulewidth}{0pt}
	\renewcommand{\footrulewidth}{0pt}}

% sidebyside environment
\newenvironment{sidebyside}{\begin{adjustwidth}{-3cm}{1cm}}{\end{adjustwidth}}

% gitinfo2 settings
\renewcommand{\gitMark}{\gitBranch\,@\,\gitAbbrevHash{}\,\textbullet{}\,\gitAuthorDate}

% setting up gitinfo2:
%   copy the file post-xxx-sample.txt from http://mirror.ctan.org/macros/latex/contrib/gitinfo2
%   and put it in .git/hooks/post-checkout
% then
%   cd .git/hooks
%   chmod g+x post-checkout
%   chmod +x post-checkout
%   cp post-checkout post-commit
%   cp post-checkout post-merge
%   cd ../..
%   git checkout master
%   git checkout develop
%   ls .git
% and you should see gitHeadInfo.gin
\begin{document}
% \begin{noindent}
	\title{\lstinline[basicstyle=\huge\ttfamily]!latexindent.pl!\\[1cm]
		Version 3.0}
% \end{noindent}
\author{Chris Hughes \footnote{and contributors! (See \vref{sec:contributors}.) For
		all communication, please visit \cite{latexindent-home}.}}
\maketitle
\begin{abstract}
	\texttt{latexindent.pl} is a \texttt{Perl} script that indents \texttt{.tex} (and other)
	files according to an indentation scheme that the user can modify to suit their
	taste. Environments, including those with alignment delimiters (such as \texttt{tabular}),
	and commands, including those that can split braces and brackets across lines,
	are \emph{usually} handled correctly by the script. Options for \texttt{verbatim}-like
	environments and indentation after headings (such as \lstinline!chapter!, \lstinline!section!, etc)
	are also available. The script also has the ability to modifiy line breaks, and add
	comment symbols.
\end{abstract}
\tableofcontents
\lstlistoflistings

\section{Introduction}
\subsection{Thanks}
I first created \texttt{latexindent.pl} to help me format chapter files
in a big project. After I blogged about it on the
\TeX{} stack exchange \cite{cmhblog} I received some positive feedback and
follow-up feature requests. A big thank you to Harish Kumar who
helped to develop and test the initial versions of the script.

The \texttt{yaml}-based interface of \texttt{latexindent.pl} was inspired
by the wonderful \texttt{arara} tool; any similarities are deliberate, and
I hope that it is perceived as the compliment that it is. Thank you to Paulo Cereda and the
team for releasing this awesome tool; I initially worried that I was going to
have to make a GUI for \texttt{latexindent.pl}, but the release of \texttt{arara}
has meant there is no need.

There have been several contributors to the project so far (and hopefully more in
the future!); thank you very much to the people detailed in \vref{sec:contributors}
for their valued contributions.

\subsection{License}
\texttt{latexindent.pl} is free and open source, and it always will be.
Before you start using it on any important files, bear in mind that \texttt{latexindent.pl} has the option to overwrite your \texttt{.tex} files.
It will always make at least one backup (you can choose how many it makes, see \cpageref{page:onlyonebackup})
but you should still be careful when using it. The script has been tested on many
files, but there are some known limitations (see \cref{sec:knownlimitations}).
You, the user, are responsible for ensuring that you maintain backups of your files
before running \texttt{latexindent.pl} on them. I think it is important at this
stage to restate an important part of the license here:
\begin{quote}\itshape
	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.
\end{quote}
There is certainly no malicious intent in releasing this script, and I do hope
that it works as you expect it to; if it does not, please first of all
make sure that you have the correct settings, and then feel free to let me know (\cite{latexindent-home}) with a
complete minimum working example as I would like to improve the code as much as possible.

\begin{warning}
	Before you try the script on anything important (like your thesis), test it
	out on the sample files in the \texttt{test-case} directory (\cite{latexindent-home}).
\end{warning}

\emph{If you have used any version 2.* of \texttt{latexindent.pl}, there
	are a few changes to the interface; see \vref{sec:moving-version} and the comments
	throughout this document for details}

\section{Demonstration: before and after}
Let's give a demonstration of some before and after code--after all, you probably
won't want to try the script if you don't much like the results. You might also
like to watch the video demonstration I made on youtube \cite{cmh:videodemo}
\fixthis{make new videos!}

As you look at \crefrange{lst:filecontentsbefore}{lst:pstricksafter}, remember
that \texttt{latexindent.pl} is just following its rules, and there is nothing
particular about these code snippets. All of the rules can be modified
so that each user can personalize their indentation scheme.

In each of the samples given in \crefrange{lst:filecontentsbefore}{lst:pstricksafter}
the `before' case is a `worst case scenario' with no effort to make indentation. The `after'
result would be the same, regardless of the leading white space at the beginning of
each line which is stripped by \texttt{latexindent.pl} (unless a \texttt{verbatim}-like
environment or \texttt{noIndentBlock} is specified -- more on this in \cref{sec:defuseloc}).

\begin{sidebyside}
	\centering
	\begin{minipage}{.55\textwidth}
		\cmhlistingsfromfile{demonstrations/filecontents1.tex}{\texttt{filecontents} before}{lst:filecontentsbefore}
	\end{minipage}\hfill
	\begin{minipage}{.55\textwidth}
		\cmhlistingsfromfile{demonstrations/filecontents1-default.tex}{\texttt{filecontents} after}{lst:filecontentsafter}
	\end{minipage}%

	\begin{minipage}{.55\textwidth}
		\cmhlistingsfromfile{demonstrations/tikzset.tex}{\texttt{tikzset} before}{lst:tikzsetbefore}
	\end{minipage}\hfill
	\begin{minipage}{.55\textwidth}
		\cmhlistingsfromfile{demonstrations/tikzset-default.tex}{\texttt{tikzset} after}{lst:tikzsetafter}
	\end{minipage}%

	\begin{minipage}{.55\textwidth}
		\cmhlistingsfromfile{demonstrations/pstricks.tex}{\texttt{pstricks} before}{lst:pstricksbefore}
	\end{minipage}\hfill
	\begin{minipage}{.55\textwidth}
		\cmhlistingsfromfile{demonstrations/pstricks-default.tex}{\texttt{pstricks} after}{lst:pstricksafter}
	\end{minipage}%
\end{sidebyside}


\section{How to use the script}
\texttt{latexindent.pl} ships as part of the \TeX Live distribution for
Linux and Mac users; \texttt{latexindent.exe} ships as part of the \TeX Live
and MiK\TeX distributions for Windows users. These files are also available
from github \cite{latexindent-home} should you wish to use them without
a \TeX{} distribution; in this case, you may like to read \vref{sec:updating-path}
which details how the \texttt{path} variable can be updated.

In what follows, we will always refer to \texttt{latexindent.pl}, but depending on
your operating system and preference, you might substitute \texttt{latexindent.exe} or
simply \texttt{latexindent}.

There are two ways to use \texttt{latexindent.pl}: from the command line,
and using \texttt{arara}; we discuss these in \cref{sec:commandline} and
\cref{sec:arara} respectively. We will discuss how to change the settings and
behaviour of the script in \vref{sec:defuseloc}.

\texttt{latexindent.pl} ships with \texttt{latexindent.exe} for Windows
users, so that you can use the script with or without a Perl distribution.
If you plan to use \texttt{latexindent.pl} (i.e, the original Perl script) then you will
need a few standard Perl modules--see \vref{sec:requiredmodules} for details.

\subsection{From the command line}\label{sec:commandline}
\texttt{latexindent.pl} has a number of different switches/flags/options, which
can be combined in any way that you like, either in short or long form as detailed below.
\texttt{latexindent.pl}  produces a \texttt{.log} file, \texttt{indent.log} every time it
is run; the name of the log file can be customised, but we will
refer to the log file as \texttt{indent.log} throughout this document.
There is a base of information that is written to \texttt{indent.log},
but other additional information will be written depending
on which of the following options are used.

\begin{commandshell}
latexindent.pl
      \end{commandshell}

This will output a welcome message to the terminal, including the version number
and available options.

\flagbox{-h, --help}

\begin{commandshell}
latexindent.pl -h
      \end{commandshell}

As above this will output a welcome message to the terminal, including the version number
and available options.\fixthis{alignment of box with item}
\begin{commandshell}
latexindent.pl myfile.tex
      \end{commandshell}

This will operate on \texttt{myfile.tex}, but will simply output to your terminal; \texttt{myfile.tex} will	not be changed in any way using this command.

\flagbox{-w, --overwrite}
\begin{commandshell}
latexindent.pl -w myfile.tex
latexindent.pl --overwrite myfile.tex
latexindent.pl myfile.tex --overwrite 
      \end{commandshell}

This \emph{will} overwrite \texttt{myfile.tex}, but it will
make a copy of \texttt{myfile.tex} first. You can control the name of
the extension (default is \texttt{.bak}), and how many different backups are made --
more on this in \cref{sec:defuseloc}, and in particular see \texttt{backupExtension} and \texttt{onlyOneBackUp}.

Note that if \texttt{latexindent.pl} can not create the backup, then it
will exit without touching your original file; an error message will be given
asking you to check the permissions of the backup file.

\flagbox{-o=output.tex,--outputfile=output.tex}
\begin{commandshell} 
latexindent.pl -o=output.tex myfile.tex
latexindent.pl myfile.tex -o=output.tex 
latexindent.pl --outputfile=output.tex myfile.tex
latexindent.pl --outputfile output.tex myfile.tex
      \end{commandshell}

This will indent \texttt{myfile.tex} and output it to \texttt{output.tex},
overwriting it (\texttt{output.tex}) if it already exists\footnote{Users of version 2.* should
	note the subtle change in syntax}. Note that if \texttt{latexindent.pl} is called with both
the \texttt{-w} and \texttt{-o} switches, then \texttt{-w} will
be ignored and \texttt{-o} will take priority (this seems safer than the
other way round).

Note that using \texttt{-o} is equivalent to using 
\begin{commandshell}
latexindent.pl myfile.tex > output.tex
\end{commandshell}

\flagbox{-s, --silent}
\begin{commandshell}
latexindent.pl -s myfile.tex
latexindent.pl myfile.tex -s
      \end{commandshell}

Silent mode: no output will be given to the terminal.

\flagbox{-t, --trace}
\begin{commandshell}
latexindent.pl -t myfile.tex
latexindent.pl myfile.tex -t
      \end{commandshell}

\label{page:traceswitch}
Tracing mode: verbose output will be given to \texttt{indent.log}. This
is useful if \texttt{latexindent.pl} has made a mistake and you're
trying to find out where and why. You might also be interested in learning
about \texttt{latexindent.pl}'s thought process -- if so, this
switch is for you although it should be noted that, especially for large files, this does affect
performance of the script.

\flagbox{-tt, --ttrace}
\begin{commandshell}
latexindent.pl -tt myfile.tex
latexindent.pl myfile.tex -tt
      \end{commandshell}

\emph{More detailed} tracing mode: this option gives more details to \texttt{indent.log}
than the standard \texttt{trace} option (note that, even more so than with \texttt{-t},
especially for large files, performance of the script will be affected).

\flagbox{-l, --local[=myyaml.yaml,other.yaml,...]}
\begin{commandshell}
latexindent.pl -l myfile.tex
latexindent.pl -l=myyaml.yaml myfile.tex
latexindent.pl -l myyaml.yaml myfile.tex
latexindent.pl -l first.yaml,second.yaml,third.yaml myfile.tex
latexindent.pl -l=first.yaml,second.yaml,third.yaml myfile.tex
latexindent.pl myfile.tex -l=first.yaml,second.yaml,third.yaml 
      \end{commandshell}

\label{page:localswitch}
Local settings: you might like to read \cref{sec:defuseloc} before
using this switch. \texttt{latexindent.pl} will always load \texttt{defaultSettings.yaml}
and if it is called with the \texttt{-l} switch and it finds \texttt{localSettings.yaml}
in the same directory as \texttt{myfile.tex} then these settings will be
added to the indentation scheme. Information will be given in \texttt{indent.log} on
the success or failure of loading \texttt{localSettings.yaml}.

The \texttt{-l} flag can take an \emph{optional} parameter which details the name (or names separated by commas) of a \texttt{yaml} file(s)
that resides in the same directory as \texttt{myfile.tex}; you can use this option if you would
like to load a settings file in the current working directory that is \emph{not} called \texttt{localSettings.yaml}.

\fixthis{local settings can accept relative paths -- how about absolute paths?}
\flagbox{-d, --onlydefault}
\begin{commandshell}
latexindent.pl -d myfile.tex
      \end{commandshell}

Only \texttt{defaultSettings.yaml}: you might like to read \cref{sec:defuseloc} before
using this switch. By default, \texttt{latexindent.pl} will always search for
\texttt{indentconfig.yaml} or \texttt{.indentconfig.yaml}  in your home directory. If you would prefer it not to do so
then (instead of deleting or renaming \texttt{indentconfig.yaml}/\texttt{.indentconfig.yaml}) you can simply
call the script with the \texttt{-d} switch; note that this will also tell
the script to ignore \texttt{localSettings.yaml} even if it has been called with the
\texttt{-l} switch.

\flagbox{-c, --cruft=<directory>}
\begin{commandshell}
latexindent.pl -c=/path/to/directory/ myfile.tex
      \end{commandshell}

If you wish to have backup files and \texttt{indent.log} written to a directory
other than the current working directory, then you can send these `cruft' files
to another directory.
% this switch was made as a result of http://tex.stackexchange.com/questions/142652/output-latexindent-auxiliary-files-to-a-different-directory

\flagbox{-g, --logfile}
\begin{commandshell}
latexindent.pl -g=other.log myfile.tex
latexindent.pl -g other.log myfile.tex
latexindent.pl --logfile other.log myfile.tex
latexindent.pl myfile.tex -g other.log 
      \end{commandshell}

By default, \texttt{latexindent.pl} reports information to \texttt{indent.log}, but if you wish to change this, simply
call the script with your chosen name after the \texttt{-g} switch.

\flagbox{-m, --modifylinebreaks}
\begin{commandshell}
latexindent.pl -m myfile.tex
latexindent.pl -modifylinebreaks myfile.tex
      \end{commandshell}

One of the most exciting developments in Version~3.0 is the ability to modify line breaks; for full details
see \vref{sec:modifylinebreaks}

\texttt{latexindent.pl} can also be called on a file without the file extension, for
example \lstinline[breaklines=true,breakatwhitespace=true,]!latexindent.pl myfile! and in which case, you can specify
the order in which extensions are searched for; see \vref{lst:fileExtensionPreference}
for full details.

\subsection{From \texttt{arara}}\label{sec:arara}
Using \texttt{latexindent.pl} from the command line is fine for some folks, but
others may find it easier to use from \texttt{arara}. \texttt{latexindent.pl}
ships with an \texttt{arara} rule, \texttt{indent.yaml}, which can be copied
to the directory of
your other \texttt{arara} rules; otherwise  you can add the directory in which \texttt{latexindent.pl}
resides to your \texttt{araraconfig.yaml} file.

Once you have told \texttt{arara} where to find your \texttt{indent} rule,
you can use it any of the ways described in \cref{lst:arara} (or combinations thereof).
In fact, \texttt{arara} allows yet greater flexibility--you can use \texttt{yes/no}, \texttt{true/false}, or \texttt{on/off} to toggle the various options.
\begin{cmhlistings}[style=demo,escapeinside={(*@}{@*)}]{\texttt{arara} sample usage}{lst:arara}
%(*@@*) arara: indent
%(*@@*) arara: indent: {overwrite: yes}
%(*@@*) arara: indent: {output: myfile.tex}
%(*@@*) arara: indent: {silent: yes}
%(*@@*) arara: indent: {trace: yes}
%(*@@*) arara: indent: {localSettings: yes}
%(*@@*) arara: indent: {onlyDefault: on}
%(*@@*) arara: indent: { cruft: /home/cmhughes/Desktop }
%(*@@*) arara: indent: { modifylinebreaks: yes }
\documentclass{article}
...
\end{cmhlistings}
\fixthis{need to update arara rule with Paulo}

Hopefully the use of these rules is fairly self-explanatory, but for completeness
\cref{tab:orbsandswitches} shows the relationship between \texttt{arara} directive arguments and the
switches given in \cref{sec:commandline}.

\begin{table}[!ht]
	\centering
	\caption{\texttt{arara} directive arguments and corresponding switches}
	\label{tab:orbsandswitches}
	\begin{tabular}{lc}
		\toprule
		\texttt{arara} directive argument & switch      \\
		\midrule
		\texttt{overwrite}                & \texttt{-w} \\
		\texttt{output}                   & \texttt{-o} \\
		\texttt{silent}                   & \texttt{-s} \\
		\texttt{trace}                    & \texttt{-t} \\
		\texttt{localSettings}            & \texttt{-l} \\
		\texttt{onlyDefault}              & \texttt{-d} \\
		\texttt{cruft}                    & \texttt{-c} \\
		\texttt{modifylinebreaks}         & \texttt{-m} \\
		\bottomrule
	\end{tabular}
\end{table}

The \texttt{cruft} directive does not work well when used with
directories that contain spaces.

\section{default, user, and local settings}\label{sec:defuseloc}
\texttt{latexindent.pl} loads its settings from \texttt{defaultSettings.yaml}
(rhymes with camel). The idea is to separate the behaviour of the script
from the internal working -- this is very similar to the way that we separate content
from form when writing our documents in \LaTeX.

\subsection{defaultSettings.yaml}
If you look in \texttt{defaultSettings.yaml} you'll find the switches
that govern the behaviour of \texttt{latexindent.pl}. If you're not sure where
\texttt{defaultSettings.yaml} resides on your computer, don't worry as \texttt{indent.log}
will tell you where to find it.
\texttt{defaultSettings.yaml} is commented,
but here is a description of what each switch is designed to do. The default
value is given in each case; whenever you see \emph{integer} in \emph{this}
section, assume that it must be greater than or equal to \texttt{0} unless
otherwise stated.

You can certainly feel free to edit \texttt{defaultSettings.yaml}, but
this is not ideal as it may be overwritten when you update your \TeX{} distribution --
all of your hard work tweaking the script would be undone! Don't worry,
there's a solution, feel free to peek ahead to \cref{sec:indentconfig} if you like.

\yamltitle{fileExtensionPreference}*{fields}
\texttt{latexindent.pl} can be called to
act on a file without
specifying the file extension.  For example we can call 
\begin{commandshell}
latexindent.pl myfile
\end{commandshell}
\begin{wrapfigure}[8]{r}[0pt]{6cm}
\begin{yaml}[firstnumber=23]{\texttt{fileExtensionPreference}}[width=.8\linewidth,before=\centering]{lst:fileExtensionPreference}
fileExtensionPreference:
    .tex: 1
    .sty: 2
    .cls: 3
    .bib: 4
	\end{yaml}
\end{wrapfigure}
in which case the script will look for \texttt{myfile} with the extensions
specified in \texttt{fileExtensionPreference} in their numeric order. If
no match is found, the script will exit. As with all of the fields, you should
change and/or add to this as necessary.

Calling \texttt{latexindent.pl myfile} with the (default) settings specified in \cref{lst:fileExtensionPreference}
means that the script will first look for \texttt{myfile.tex}, then \texttt{myfile.sty}, \texttt{myfile.cls},
and finally \texttt{myfile.bib} in order.

\yamltitle{backupExtension}*{extension name}

If you call \texttt{latexindent.pl} with the \texttt{-w} switch (to overwrite
\texttt{myfile.tex}) then it will create a backup file before doing
any indentation; the default extension is \texttt{.bak}, so, for example, \texttt{myfile.bak0}
would be created when calling \texttt{latexindent.pl myfile.tex}.

By default, every time you subsequently call \texttt{latexindent.pl} with
the \texttt{-w} to act upon \texttt{myfile.tex}, it will create successive back up files: \texttt{myfile.bak1}, \texttt{myfile.bak2},
etc.

\yamltitle{onlyOneBackUp}*{integer}
\label{page:onlyonebackup}
If you don't want a backup for every time that you call \texttt{latexindent.pl} (so
you don't want \texttt{myfile.bak1}, \texttt{myfile.bak2}, etc) and you simply
want \texttt{myfile.bak} (or whatever you chose \texttt{backupExtension} to be)
then change \texttt{onlyOneBackUp} to \texttt{1}; the default value of
\texttt{onlyOneBackUp} is \texttt{0}.

\yamltitle{maxNumberOfBackUps}*{integer}
Some users may only want a finite number of backup files,
say at most $3$, in which case, they can change this switch.
The smallest value of \texttt{maxNumberOfBackUps} is $0$ which will \emph{not}
prevent backup files being made; in this case, the behaviour will be dictated
entirely by \texttt{onlyOneBackUp}. The default value of \texttt{maxNumberOfBackUps}
is \texttt{0}.

\yamltitle{cycleThroughBackUps}*{integer}
Some users may wish to cycle through backup files, by deleting the
oldest backup file and keeping only the most recent; for example,
with \texttt{maxNumberOfBackUps: 4}, and \texttt{cycleThroughBackUps}
set to \texttt{1}  then the \texttt{copy} procedure given below
would be obeyed.

\begin{commandshell}
copy myfile.bak1 to myfile.bak0
copy myfile.bak2 to myfile.bak1
copy myfile.bak3 to myfile.bak2
copy myfile.bak4 to myfile.bak3
	\end{commandshell}
The default value of \texttt{cycleThroughBackUps} is \texttt{0}.

\yamltitle{verbatimEnvironments}*{fields} 

\begin{wrapfigure}[14]{r}[0pt]{6cm}
\begin{yaml}{\texttt{verbatimEnvironments}}[width=.8\linewidth,before=\centering]{lst:verbatimEnvironments}
verbatimEnvironments:
    verbatim: 1
    lstlisting: 1
	\end{yaml}\\
    \vspace{.2cm}
\begin{yaml}{\texttt{verbatimCommands}}[width=.8\linewidth,before=\centering]{lst:verbatimCommands}
verbatimCommands:
    verb: 1
    lstinline: 1
\end{yaml}
\end{wrapfigure}
A field that contains a list of environments
that you would like left completely alone -- no indentation will be performed
on environments that you have specified in this field, see \cref{lst:verbatimEnvironments}.

Note that if  you put an environment in \texttt{verbatimEnvironments}
and in other fields such as \texttt{lookForAlignDelims} or \texttt{noAdditionalIndent}
then \texttt{latexindent.pl} will \emph{always} prioritize \texttt{verbatimEnvironments}.

\yamltitle{verbatimCommands}*{fields}
A field that contains a list of commands that are verbatim commands, for example
\lstinline|\lstinline|; any commands populated in this field are protected from line breaking 
routines (only relevant if the \texttt{-m} is active, see \vref{sec:m-switch}).

\yamltitle{noIndentBlock}*{fields} 

\begin{wrapfigure}[8]{r}[0pt]{6cm}
\begin{yaml}{\texttt{noIndentBlock}}[width=.8\linewidth,before=\centering]{lst:noIndentBlock}
noIndentBlock:
    noindent: 1
    cmhtest: 1
	\end{yaml}
\end{wrapfigure}
If you have a block of code that you don't want \texttt{latexindent.pl} to touch (even if it is \emph{not} a verbatim-like
environment) then you can wrap it in an environment from \texttt{noIndentBlock};
you can use any name you like for this, provided you populate it as demonstrate in
\cref{lst:noIndentBlock}.

Of course, you don't want to have to specify these as null environments
in your code, so you use them with a comment symbol, \lstinline!%!, followed
by as many spaces (possibly none) as you like; see \cref{lst:noIndentBlockdemo} for
example.

\begin{cmhlistings}[style=demo,escapeinside={(*@}{@*)}]{\texttt{noIndentBlock} demonstration}{lst:noIndentBlockdemo}
%(*@@*) \begin{noindent}
        this code
                won't
     be touched
                    by
             latexindent.pl!
%(*@@*)\end{noindent}
	\end{cmhlistings}

\yamltitle{removeTrailingWhitespace}*{fields}

\begin{wrapfigure}[12]{r}[0pt]{6cm}
\begin{yaml}[firstnumber=71]{removeTrailingWhitespace}[width=.8\linewidth,before=\centering]{lst:removeTrailingWhitespace}
removeTrailingWhitespace:
    beforeProcessing: 0
    afterProcessing: 1
\end{yaml}\\
\vspace{.2cm}
\begin{yaml}{\texttt{fileContentsEnvironments}}[width=.8\linewidth,before=\centering]{lst:fileContentsEnvironments}
fileContentsEnvironments:
    filecontents: 1
    filecontents*: 1
  \end{yaml}
\end{wrapfigure}
Trailing white space can be removed both \emph{before} and \emph{after} processing 
the document, as detailed in \cref{lst:removeTrailingWhitespace}; each of the fields 
can take the values \texttt{0} or \texttt{1}.
Thanks to \cite{vosskuhle} for providing this feature.

\yamltitle{fileContentsEnvironments}*{field}

Before \texttt{latexindent.pl} determines the difference between preamble (if any) and the main document,
it first searches for any of the environments specified in \texttt{fileContentsEnvironments}, see
\cref{lst:fileContentsEnvironments}.
  The behaviour of \texttt{latexindent.pl} on these environments is determined by their location (preamble or not), and 
  the value \texttt{indentPreamble}, discussed next.

\yamltitle{indentPreamble}{0|1}

The preamble of a document can sometimes contain some trickier code
for \texttt{latexindent.pl} to operate upon. By default, \texttt{latexindent.pl}
won't try to operate on the preamble (as \texttt{indentPreamble} is set to \texttt{0},
by default), but if you'd like \texttt{latexindent.pl} to try then change \texttt{indentPreamble} to \texttt{1}.

\yamltitle{lookForPreamble}*{fields}

\begin{wrapfigure}[8]{r}[0pt]{5cm}
\begin{yaml}[firstnumber=57]{lookForPreamble}[width=.8\linewidth,before=\centering]{lst:lookForPreamble}
lookForPreamble:
    .tex: 1
    .sty: 0
    .cls: 0
    .bib: 0
\end{yaml}
\end{wrapfigure}
Not all files contain preamble; for example, \texttt{sty}, \texttt{cls} and \texttt{bib} files typically do \emph{not}. Referencing
\cref{lst:lookForPreamble}, if you set, for example, \texttt{.tex} to \texttt{0}, then regardless of the setting of the value of \texttt{indentPreamble}, preamble
will not be assumed when operating upon \texttt{.tex} files.
\yamltitle{preambleCommandsBeforeEnvironments}{0|1}
Assuming that \texttt{latexindent.pl} is asked to operate upon the preamble of a document,
when this switch is set to \texttt{0} then environment code blocks will be sought first, 
and then command code blocks. When this switch is set to \texttt{1}, commands 
will be sought first. The example that first motivated this switch contained the code given in \cref{lst:motivatepreambleCommandsBeforeEnvironments}.

\begin{cmhlistings}{Motivating \texttt{preambleCommandsBeforeEnvironments}}{lst:motivatepreambleCommandsBeforeEnvironments}
...
preheadhook={\begin{mdframed}[style=myframedstyle]},
postfoothook=\end{mdframed},
...
\end{cmhlistings}

\yamltitle{defaultIndent}*{horizontal space}
This is the default indentation (\lstinline!\t! means a tab, and is the default value) used in the absence of other details
for the command or environment we are working with; see \texttt{indentRules}
for more details (\cpageref{page:indentRules}).

If you're interested in experimenting with \texttt{latexindent.pl} then you
can \emph{remove} all indentation by setting \texttt{defaultIndent: ""}



\yamltitle{lookForAlignDelims}*{fields}
\begin{wrapfigure}[12]{r}[0pt]{5cm}
\begin{yaml}[numbers=none]{\texttt{lookForAlignDelims} (basic)}[width=.8\linewidth,before=\centering]{lst:aligndelims:basic}
lookForAlignDelims:
   tabular: 1
   tabularx: 1
   longtable: 1
   array: 1
   matrix: 1
   ...
	\end{yaml}
  \end{wrapfigure}
This contains a list of environments and/or commands that 
are operated upon in a special way by \texttt{latexindent.pl} (see \cref{lst:aligndelims:basic}).
In fact, the fields in \texttt{lookForAlignDelims} can actually
take two different forms: the \emph{basic} version is shown in \cref{lst:aligndelims:basic}
and the \emph{advanced} version in \cref{lst:aligndelims:advanced}; we will discuss each in turn.

The environments specified in this field will be operated on in a special way  by \texttt{latexindent.pl}. In particular, it will try and align each column by its alignment
tabs. It does have some limitations (discussed further in \cref{sec:knownlimitations}),
but in many cases it will produce results such as those in \cref{lst:tabularbefore:basic,lst:tabularafter:basic}.

If you find that \texttt{latexindent.pl} does not perform satisfactorily on such
environments then you can set the relevant key to \texttt{0}, for example \texttt{tabular: 0}; alternatively, if you just want to ignore \emph{specific}
instances of the environment, you could wrap them in something from \texttt{noIndentBlock} (see \cref{lst:noIndentBlock}).

\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile[columns=fixed]{demonstrations/tabular1.tex}{\texttt{tabular} before}{lst:tabularbefore:basic}
\end{minipage}%
\hfill
\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile[columns=fixed]{demonstrations/tabular1-default.tex}{\texttt{tabular} after (basic)}{lst:tabularafter:basic}
\end{minipage}%

If you wish to remove the alignment of the \lstinline!\\! within a delimiter-aligned block, then the
advanced form of \texttt{lookForAlignDelims} shown in \cref{lst:aligndelims:advanced} is for you.
\begin{yaml}[firstnumber=77]{\texttt{lookForAlignDelims} (advanced)}{lst:aligndelims:advanced}
lookForAlignDelims:
   tabular: 
      delims: 1
      alignDoubleBackSlash: 0
      spacesBeforeDoubleBackSlash: 0
   tabularx:
      delims: 1
   longtable: 1
	\end{yaml}

Note that you can use a mixture of the basic and advanced form: in \cref{lst:aligndelims:advanced} \texttt{tabular} and \texttt{tabularx}
are advanced and \texttt{longtable} is basic. When using the advanced form, each field should receive at least 1 sub-field, and \emph{can} (but does not have to) receive up to 3 fields:
\begin{itemize}
	\item \texttt{delims}: switch equivalent to simply specifying, for example, \texttt{tabular: 1} in
	      the basic version shown in \cref{lst:aligndelims:basic} (default: 1);
	\item \texttt{alignDoubleBackSlash}: switch to determine if \lstinline!\\! should be aligned (default: 1);
	\item \texttt{spacesBeforeDoubleBackSlash}: optionally, specifies the number of spaces to be inserted
	      before (non-aligned) \lstinline!\\!. In order to use this field, \texttt{alignDoubleBackSlash} needs
	      to be set to 0 (default: 0).
\end{itemize}

Assuming that you have the settings in \cref{lst:aligndelims:advanced} saved in \texttt{mysettings.yaml}, and the code 
from \cref{lst:tabularbefore:basic} in \texttt{myfile.tex} and you run
\begin{commandshell}
latexindent.pl -l mysettings.yaml myfile.tex 
\end{commandshell}
then you should receive the before-and-after results shown in
\cref{lst:tabularbefore:advanced,lst:tabularafter:advanced}; note that the ampersands have been aligned, but
the \lstinline!\\! have not (compare the alignment of \lstinline!\\! in \cref{lst:tabularafter:basic,lst:tabularafter:advanced}).

\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile[columns=fixed]{demonstrations/tabular1.tex}{\texttt{tabular} before }{lst:tabularbefore:advanced}
\end{minipage}%
\hfill
\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile[columns=fixed]{demonstrations/tabular1-advanced.tex}{\texttt{tabular} after (advanced)}{lst:tabularafter:advanced}
\end{minipage}%

Using  \texttt{spacesBeforeDoubleBackSlash: 3} gives \cref{lst:tabularbefore:spacing,lst:tabularafter:spacing},
note the spacing before the \lstinline!\\! in \cref{lst:tabularafter:spacing}.

\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile[columns=fixed]{demonstrations/tabular1.tex}{\texttt{tabular} before}{lst:tabularbefore:spacing}
\end{minipage}%
\hfill
\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile[columns=fixed]{demonstrations/tabular1-advanced-3spaces.tex}{\texttt{tabular} after (spacing)}{lst:tabularafter:spacing}
\end{minipage}%

As of Version 3.0, the alignment routine works on mandatory and optional arguments within commands, and also within `special' code blocks 
(see \fixthis{need a reference to special section!}); for example, assuming that you have a command called \lstinline!\matrix!
and that it is populated within \texttt{lookForAlignDelims} (which it is, by default), then the before-and-after results
shown in \cref{lst:matrixbefore,lst:matrixafter} are achievable by default.

\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile[columns=fixed]{demonstrations/matrix1.tex}{\texttt{matrix} before}{lst:matrixbefore}
\end{minipage}%
\hfill
\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile[columns=fixed]{demonstrations/matrix1-default.tex}{\texttt{matrix} after}{lst:matrixafter}
\end{minipage}%


\fixthis{need to resolve alignment outside of environments}
%If you have blocks of code that you wish to align at the \&  character that
%are \emph{not} wrapped in, for example, \texttt{\begin{tabular}\ldots\end{tabular}}, then you use the mark up
%  illustrated in \cref{lst:alignmentmarkup}. Note that the \texttt{%*} must be next to
%  each other, but that there can be any number of spaces (possibly none) between the
%  \texttt{*} and \texttt{\begin{tabular}}; note also that you may use any
%    environment name that you have specified in \texttt{lookForAlignDelims}.
%    \begin{cmhlistings}[style=demo,columns=fixed]{Mark up for aligning delimiters outside of environments}{lst:alignmentmarkup}
%      \matrix{%
%      %* \begin{tabular}
%         1 & 2 & 3 & 4 \\
%         5 &   & 6 &   \\
%        %* \end{tabular}
%        }

\fixthis{final check: line numbers in yaml}

\yamltitle{indentAfterItems}*{fields} 
The environments specified in \texttt{indentAfterItems}  tell
\texttt{latexindent.pl} to look for \lstinline!\item! commands; if these switches are set to \texttt{1}
then indentation will be performed so as indent the code after each \texttt{item}.
\begin{yaml}{\texttt{indentAfterItems}}{lst:indentafteritems}
indentAfterItems:
    itemize: 1
    enumerate: 1
	\end{yaml}
A demonstration is given in \cref{lst:itemsbefore,lst:itemsafter}

\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile{demonstrations/items1.tex}{\texttt{items} before}{lst:itemsbefore}
\end{minipage}%
\hfill
\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile{demonstrations/items1-default.tex}{\texttt{items} after}{lst:itemsafter}
\end{minipage}

\yamltitle{itemNames}*{fields} 
If you have your own \texttt{item} commands (perhaps you
prefer to use \texttt{myitem}, for example)
then you can put populate them in \texttt{itemNames}.
For example, users of the \texttt{exam} document class might like to add
\texttt{parts} to \texttt{indentAfterItems} and \texttt{part} to \texttt{itemNames}
to their user settings--see \vref{sec:indentconfig} for details of how to configure user settings,
and \vref{lst:mysettings} in particular.\label{page:examsettings}

\begin{yaml}{\texttt{itemNames}}{lst:itemNames}
indentAfterItems:
    item: 1
    myitem: 1
	\end{yaml}

\yamltitle{specialBeginEnd}*{fields}
The fields specified in \texttt{specialBeginEnd} are, in their default state, focused on math mode begin and end statements, but 
there is no requirement for this to be the case; \cref{lst:specialBeginEnd} shows the 
default settings of \texttt{specialBeginEnd}.
\begin{yaml}{\texttt{specialBeginEnd}}{lst:specialBeginEnd}
specialBeginEnd:
    displayMath:
        begin: '\\\['
        end: '\\\]'
        lookForThis: 1
    inlineMath:
        begin: '(?<!\$)(?<!\\)\$(?!\$)'
        end: '(?<!\\)\$(?!\$)'
        lookForThis: 1
    displayMathTeX:
        begin: '\$\$'
        end: '\$\$'
        lookForThis: 1
	\end{yaml}

    The field \texttt{displayMath} represents \lstinline!\[...\]!, \texttt{inlineMath} represents
    \lstinline!$...$! and \texttt{displayMathTex} represents \lstinline!$$...$$!. You can, of course, 
    rename these in your own YAML files (see \vref{sec:localsettings}); indeed, you 
    might like to set up your own specil begin and end statements.

    A demonstration of the before-and-after results are shown in \cref{lst:specialbefore,lst:specialafter}.

\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile{demonstrations/special1.tex}{\texttt{special} before}{lst:specialbefore}
\end{minipage}%
\hfill
\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile{demonstrations/special1-default.tex}{\texttt{special} after}{lst:specialafter}
\end{minipage}

For each field, the \texttt{lookForThis} is set to \texttt{1} by default, which means that \texttt{latexindent.pl}
will look for this pattern; you can tell \texttt{latexindent.pl} not to look for the pattern, by setting 
\texttt{lookForThis} to \texttt{0}. 

\yamltitle{indentAfterHeadings}*{fields} 
This field enables the user to specify
indentation rules that take effect after heading commands such as \lstinline!\part!, \lstinline!\chapter!,
\lstinline!\section!, \lstinline!\subsection*!, or indeed any user-specified command written in this field. 

This field is slightly different from most
of the fields that we have considered previously, because each element is
itself a field which has two elements: \texttt{indent} and \texttt{level}. (Similar
in structure to the advanced form of  \texttt{lookForAlignDelims} in \cref{lst:aligndelims:advanced}.)
\begin{yaml}{\texttt{indentAfterHeadings}}{lst:indentAfterHeadings}
indentAfterHeadings:
    part:
       indentAfterThisHeading: 0
       level: 1
    chapter:
       indentAfterThisHeading: 0
       level: 2
    section:
       indentAfterThisHeading: 0
       level: 3
    ...
	\end{yaml}
The default settings do \emph{not} place indentation after a heading, but you
can easily switch them on by changing \texttt{indentAfterThisHeading: 0} to \texttt{indentAfterThisHeading: 1}.
The \texttt{level} field tells \texttt{latexindent.pl} the hierarchy of the heading
structure in your document. You might, for example, like to have both \texttt{section}
and \texttt{subsection} set with \texttt{level: 3} because you do not want the indentation to go too deep.

You can add any of your own custom heading commands to this field, specifying the \texttt{level}
as appropriate.  You can also specify your own indentation in \texttt{indentRules} \fixthis{need a reference to indentRules};
you will find the default \texttt{indentRules} contains \lstinline!chapter: " "! which
tells \texttt{latexindent.pl} simply to use a space character after \texttt{\chapter} headings
(once \texttt{indent} is set to \texttt{1} for \texttt{chapter}).

For example, assuming that you have read \vref{sec:localsettings}, say that 
you have the code in \cref{lst:headings1} saved into \texttt{headings1.yaml},
and that you have the text from \cref{lst:headings1} saved into \texttt{headings1.tex}. 

\begin{minipage}{.45\textwidth}
\begin{yaml}{\texttt{headings1.yaml}}{lst:headings1}
indentAfterHeadings:
    subsection:
       indentAfterThisHeading: 1
       level: 1
    paragraph:
       indentAfterThisHeading: 1
       level: 2
\end{yaml}
\end{minipage}%
\hfill
\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile{demonstrations/headings1.tex}{\texttt{headings1.tex}}{lst:headings1}
\end{minipage}

If you run the command
\begin{commandshell}
latexindent.pl headings1.tex -l=headings1.yaml
\end{commandshell}
then you should receive the output given in \cref{lst:headings1-mod1}.

\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile{demonstrations/headings1-mod1.tex}{\texttt{headings1.tex} 1st modification}{lst:headings1-mod1}
\end{minipage}%
\hfill
\begin{minipage}{.45\textwidth}
\cmhlistingsfromfile{demonstrations/headings1-mod2.tex}{\texttt{headings1.tex} second modification}{lst:headings1-mod2}
\end{minipage}

Now say that you modify the \texttt{YAML} from \cref{lst:headings1} so that the \texttt{paragraph} \texttt{level} is \texttt{1}; after 
running
\begin{commandshell}
latexindent.pl headings1.tex -l=headings1.yaml
\end{commandshell}
you should now receive the code given in \cref{lst:headings1-mod2}; notice that
the \texttt{paragraph} and \texttt{subsection} are at the same indentation level.
\end{document}


%    # noAdditionalIndent can be a scalar or a hash, e.g
%    #
%    #   noAdditionalIndent:
%    #       myexample: 1
%    #
%    # OR
%    #
%    #   noAdditionalIndent:
%    #       myexample: 
%    #           body: 1
%    #           optionalArguments: 1
%    #           mandatoryArguments: 1
%    # 
%    # specifying as a scalar with no field (e.g myexample: 1)
%    # will be interpreted as noAdditionalIndent for *every*
%    # field, so the body, optional arguments and mandatory arguments
%    # will *all* receive noAdditionalIndent 
%    #
%    # indentRules can also be a scalar or a hash, e.g
%    #   indentRules:
%    #       myexample: "\t"
%    #
%    # OR
%    #
%    #   indentRules:
%    #       myexample:
%    #           body: "  "
%    #           optionalArguments: "\t \t"
%    #           mandatoryArguments: ""
%    #
%    # specifying as a scalar with no field will
%    # mean that *every* field will receive the same treatment

\item[\verbitem{noAdditionalIndent}] If you would prefer some of your
environments or commands not to receive any additional indent, then
populate \texttt{noAdditionalIndent}; see \cref{lst:noAdditionalIndent}.
Note that these environments will still receive the \emph{current} level
of indentation unless they belong to \texttt{verbatimEnvironments}, or \texttt{noIndentBlock}.

\begin{cmhlistings}[style=yaml]{\texttt{noAdditionalIndent}}{lst:noAdditionalIndent}
noAdditionalIndent:
    document: 1
    myexample: 1
    mydefinition: 1
    problem: 1
    exercises: 1
    mysolution: 1
    foreach: 0
    widepage: 1
    comment: 1
    \[: 1
    \]: 1
    frame: 0
	\end{cmhlistings}
Note in particular from \cref{lst:noAdditionalIndent} that if you wish content within
\texttt{\[}  and \texttt{\]} to receive no additional indentation then
you have to specify \emph{both} as \texttt{1} (the default is \texttt{0}).
If you do not specify both as the same value you may get some interesting results!

%    # set noAdditionalIndent globally for codeblocks
%    noAdditionalIndentGlobal:
%        environments: 0
%        commands: 1
%        optionalArguments: 0
%        mandatoryArguments: 0
%        ifElseFi: 0
%        items: 0

This specifies noAdditionalIndent globally for code blocks; if this is specified as $1$,
then noAdditionalIndent and indentRules will be ignored for these code blocks.

%# set indentRules globally for codeblocks; these need 
%# to be horizontal spaces, if they are to be used
%indentRulesGlobal:
%    environments: 0
%    commands: 0
%    optionalArguments: 0
%    mandatoryArguments: 0
%    ifElseFi: 0
%    items: 0

\item[\verbitem{indentRules}] If\label{page:indentRules} you would prefer to specify
individual rules for certain environments or commands, just
populate \texttt{indentRules}; see \cref{lst:indentRules}

\begin{cmhlistings}[style=yaml]{\texttt{indentRules}}{lst:indentRules}
indentRules:
   myenvironment: "\t\t"
   anotherenvironment: "\t\t\t\t"
   \[: "\t"
	\end{cmhlistings}      %%%%%\] just here to stop vim from colouring the rest of my code
Note that in contrast to \texttt{noAdditionalIndent} you do \emph{not}
need to specify both \texttt{\[} and \texttt{\]} in this field.

If you put an environment in both \texttt{noAdditionalIndent} and in
\texttt{indentRules} then \texttt{latexindent.pl} will resolve the conflict
by ignoring \texttt{indentRules} and prioritizing \texttt{noAdditionalIndent}.
You will get a warning message in \texttt{indent.log}; note that you will only
get one warning message per command or environment. Further discussion
is given in \cref{sec:fieldhierachy}.

In summary, The hierachy is
\begin{enumerate}
	\item noAdditionalIndent (on a per-name basis)
	\item noAdditionalIndentGlobal
	\item indentRules (on a per-name basis)
	\item indentRulesGlobal
	\item defaultIndent
\end{enumerate}


\item[\verbitem{constructIfElseFi}] The commands specified in this field
will tell \texttt{latexindent.pl} to look for constructs that
have the form \texttt{\if...} \texttt{\else...} \texttt{\fi}, such as,
for example, \texttt{\ifnum}; see \cref{lst:iffibefore,lst:iffiafter} for
a before-and-after demonstration.

\begin{minipage}{.5\textwidth}
	\begin{cmhlistings}[style=demo,xleftmargin=-3mm,columns=fixed]{\texttt{if-else-fi} construct before}{lst:iffibefore}
\ifnum\radius>5
\ifnum\radius<16
\draw[decorate,...
\fi
\fi
	      	\end{cmhlistings}
\end{minipage}%
\begin{minipage}{.5\textwidth}
	\begin{cmhlistings}[style=demo,xleftmargin=-3mm,columns=fixed]{\texttt{if-else-fi} construct after}{lst:iffiafter}
\ifnum\radius>5
    \ifnum\radius<16
    	\draw[decorate,...
	\fi
\fi
	      	\end{cmhlistings}
\end{minipage}

\item[\verbitem{logFilePreferences}]
\texttt{latexindent.pl} writes information to \texttt{indent.log}, some
of which can be customised by changing \texttt{logFilePreferences}; see \cref{lst:logFilePreferences}.
\begin{cmhlistings}[style=yaml]{\texttt{logFilePreferences}}{lst:logFilePreferences}
logFilePreferences:
    logFileName: "indent.log"
    showEveryYamlRead: 1
    showAmalgamatedSettings: 0
    endLogFileWith: '--------------' 
  \end{cmhlistings}
You can customize the name of your logfile to anything you like by changing \texttt{logFileName}.
If you load your own user settings (see \vref{sec:indentconfig}) then \texttt{latexindent.pl} will
detail them in \texttt{indent.log}; you can choose not to have the details logged by switching
\texttt{showEveryYamlRead} to \texttt{0}. Once all of your settings have
been loaded, you can see the amalgamated settings by switching \texttt{showAmalgamatedSettings}
to \texttt{1}, if you wish. The log file will end with the characters
given in \texttt{endLogFileWith}.

\subsubsection{Hierarchy of fields}\label{sec:fieldhierachy}
After reading the previous section, it should sound reasonable that
\texttt{noAdditionalIndent}, \texttt{indentRules}, and
\texttt{verbatim} all serve mutually exclusive tasks. Naturally, you may
well wonder what happens if you choose to ask \texttt{latexindent.pl} to
prioritize one above the other.

For example, let's say that (after reading \cref{sec:indentconfig}) you put the fields in \cref{lst:conflict} into
one of your settings files.
\begin{cmhlistings}[style=yaml]{Conflicting ideas}{lst:conflict}
indentRules:
   myenvironment: "\t\t"
noAdditionalIndent:
   myenvironment: 1
\end{cmhlistings}

Clearly these fields conflict: first of all
you are telling \texttt{latexindent.pl} that \texttt{myenvironment} should
receive two tabs of indentation, and then you are telling it
not to put any indentation in the environment. \texttt{latexindent.pl}
will always make the decision to prioritize \texttt{noAdditionalIndent} above
\texttt{indentRules} regardless of the order that you load them in
your settings file. The first
time it encounters \texttt{myenvironment} it will put a warning in \texttt{indent.log}
and delete the offending key from \texttt{indentRules} so that any future
conflicts will not have to be addressed.

Let's consider another conflicting example in \cref{lst:bigconflict}
\begin{cmhlistings}[style=yaml]{More conflicting ideas}{lst:bigconflict}
lookForAlignDelims:
   myenvironment: 1
verbatimEnvironments:
   myenvironment: 1
\end{cmhlistings}
This is quite a significant conflict--we are first of all telling \texttt{latexindent.pl}
to look for alignment delimiters in \texttt{myenvironment} and then
telling it that actually we would like \texttt{myenvironment} to be considered
as a \texttt{verbatim}-like environment. Regardless of the order that we
state \cref{lst:bigconflict} the \texttt{verbatim} instruction will always win.
As in \cref{lst:conflict} you will only receive a warning in \texttt{indent.log} the
first time \texttt{latexindent.pl} encounters \texttt{myenvironment} as the
offending key is deleted from \texttt{lookForAlignDelims}.

To summarize, \texttt{latexindent.pl} will prioritize the various fields in the
following order:
\begin{enumerate}
	\item \texttt{verbatimEnvironments}
	\item \texttt{noAdditionalIndent}
	\item \texttt{indentRules}
\end{enumerate}
\subsection{\texttt{indentconfig.yaml} and \texttt{.indentconfig.yaml} (for user settings)}\label{sec:indentconfig}
Editing \texttt{defaultSettings.yaml} is not ideal as it may be overwritten when
updating your distribution--a better way to customize the settings to your liking
is to set up your own settings file,
\texttt{mysettings.yaml} (or any name you like, provided it ends with \texttt{.yaml}).
The only thing you have to do is tell \texttt{latexindent.pl} where to find it.

\texttt{latexindent.pl} will always check your home directory for \texttt{indentconfig.yaml}
and  \texttt{.indentconfig.yaml} (unless
it is called with the \texttt{-d} switch),
which is a plain text file you can create that contains the \emph{absolute}
paths for any settings files that you wish \texttt{latexindent.pl} to load. There is no difference
between \texttt{indentconfig.yaml} and \texttt{.indentconfig.yaml}, other than the
fact that \texttt{.indentconfig.yaml} is a `hidden' file; thank you to \cite{jacobo-diaz-hidden-config}
for providing this feature. In what follows, we will use \texttt{indentconfig.yaml}, but it
is understood that this equally represents \texttt{.indentconfig.yaml} as well. If you
have both files in existence,  \texttt{indentconfig.yaml} takes priority.

For Mac and Linux users, their home directory is \texttt{~/username} while
Windows (Vista onwards) is \texttt{C:\Users\username} \footnote{If you're not sure
	where to put \texttt{indentconfig.yaml}, don't
	worry \texttt{latexindent.pl} will tell you in the log file exactly where to
	put it assuming it doesn't exist already.}
\Cref{lst:indentconfig} shows a sample \texttt{indentconfig.yaml} file.

\begin{cmhlistings}[style=yaml]{\texttt{indentconfig.yaml} (sample)}{lst:indentconfig}
# Paths to user settings for latexindent.pl
#
# Note that the settings will be read in the order you
# specify here- each successive settings file will overwrite
# the variables that you specify

paths:
- /home/cmhughes/Documents/yamlfiles/mysettings.yaml
- /home/cmhughes/folder/othersettings.yaml
- /some/other/folder/anynameyouwant.yaml
- C:\Users\chughes\Documents\mysettings.yaml
- C:\Users\chughes\Desktop\test spaces\more spaces.yaml
\end{cmhlistings}

Note that the \texttt{.yaml} files you specify in \texttt{indentconfig.yaml}
will be loaded in the order that you write them in. Each file doesn't have
to have every switch from \texttt{defaultSettings.yaml}; in fact, I recommend
that you only keep the switches that you want to \emph{change} in these
settings files.

To get started with your own settings file, you might like to save a copy of
\texttt{defaultSettings.yaml} in another directory and call it, for
example, \texttt{mysettings.yaml}. Once you have added the path to \texttt{indentconfig.yaml}
feel free to start changing the switches and adding more environments to it
as you see fit--have a look at \cref{lst:mysettings} for an example
that uses four tabs for the default indent, adds the \texttt{tabbing}
environment to the list of environments that contains alignment delimiters,
and adds the changes we described on \cpageref{page:examsettings}.

\begin{cmhlistings}[style=yaml]{\texttt{mysettings.yaml} (example)}{lst:mysettings}
# Default value of indentation
defaultIndent: "\t\t\t\t"

# environments that have tab delimiters, add more
# as needed
lookForAlignDelims:
   tabbing: 1

# If you use the exam documentclass, you might 
# like the following settings
# environments that have \item commands
indentAfterItems:
    parts: 1

# commands to be treated like \item
itemNames:
    part: 1
\end{cmhlistings}

You can make sure that your settings are loaded by checking \texttt{indent.log}
for details--if you have specified a path that \texttt{latexindent.pl} doesn't
recognize then you'll get a warning, otherwise you'll get confirmation that
\texttt{latexindent.pl} has read your settings file \footnote{Windows users
	may find that they have to end \texttt{.yaml} files with a blank line}.

\begin{warning}
	When editing \texttt{.yaml} files it is \emph{extremely} important
	to remember how sensitive they are to spaces. I highly recommend copying
	and pasting from \texttt{defaultSettings.yaml} when you create your
	first \texttt{whatevernameyoulike.yaml} file.

	If \texttt{latexindent.pl} can not read your \texttt{.yaml} file it
	will tell you so in \texttt{indent.log}.
\end{warning}

\subsection{\texttt{localSettings.yaml}}\label{sec:localsettings}
You may remember on \cpageref{page:localswitch} we discussed the \texttt{-l} switch
that tells \texttt{latexindent.pl} to look for \texttt{localSettings.yaml} in the
\emph{same directory} as \texttt{myfile.tex}. This settings file will
be read \emph{after} \texttt{defaultSettings.yaml} and, assuming they exist,
user settings.

The \emph{local} settings file may be called \texttt{localSettings.yaml}, and
it can contain any switches that you'd
like to change--a sample is shown in \cref{lst:localSettings}.

\begin{cmhlistings}[style=yaml]{\texttt{localSettings.yaml} (example)}{lst:localSettings}
# Default value of indentation
defaultIndent: " "

# environments that have tab delimiters, add more
# as needed
lookForAlignDelims:
   tabbing: 0

#  verbatim environments- environments specified
#  in this hash table will not be changed at all!
verbatimEnvironments:
    cmhenvironment: 0
\end{cmhlistings}

\fixthis{expand on this!}

You can make sure that your local settings are loaded by checking \texttt{indent.log}
for details--if \texttt{localSettings.yaml} can not be read then you will
get a warning, otherwise you'll get confirmation that
\texttt{latexindent.pl} has read \texttt{localSettings.yaml}.

If you'd prefer to name your \texttt{localSettings.yaml} file something different, (say, \texttt{myyaml.yaml}) then
you can call \texttt{latexindent.pl} using, for example, \lstinline[breaklines=true]!latexindent.pl -l=myyaml.yaml myfile.tex!.

\subsection{Settings load order}\label{sec:loadorder}
\texttt{latexindent.pl} loads the settings files in the following order:
\begin{enumerate}
	\item \texttt{defaultSettings.yaml} is always loaded, and can not be renamed;
	\item \texttt{anyUserSettings.yaml} and any other arbitrarily-named files specified in \texttt{indentconfig.yaml};
	\item \texttt{localSettings.yaml} but only if found in the same directory as \texttt{myfile.tex} and called
	      with \texttt{-l} switch; this file can be renamed, provided that the call to \texttt{latexindent.pl} is adjusted
	      accordingly (see \cref{sec:localsettings}).
\end{enumerate}
A visual representation of this is given in \cref{fig:loadorder}.

\begin{figure}
	\centering
	\begin{tikzpicture}[
			needed/.style={very thick, draw=blue,fill=blue!20,
					text centered, minimum height=2.5em,rounded corners=1ex},
			optional/.style={draw=black, very thick,scale=0.8,
					text centered, minimum height=2.5em,rounded corners=1ex},
			optionalfill/.style={fill=black!10},
			connections/.style={draw=black!30,dotted,line width=3pt,text=red},
		]
		% Draw diagram elements
		\node (latexindent) [needed,circle]  {\texttt{latexindent.pl}};
		\node (default) [needed,above right=.5cm of latexindent]  {\texttt{defaultSettings.yaml}};
		\node (indentconfig) [optional,right=of latexindent]  {\texttt{indentconfig.yaml}};
		\node (any) [optional,optionalfill,above right=of indentconfig]  {\texttt{any.yaml}};
		\node (name) [optional,optionalfill,right=of indentconfig]  {\texttt{name.yaml}};
		\node (you) [optional,optionalfill,below right=of indentconfig]  {\texttt{you.yaml}};
		\node (want) [optional,optionalfill,below=of indentconfig]  {\texttt{want.yaml}};
		\node (local) [optional,below=of latexindent]  {\texttt{localSettings.yaml}};
		% Draw arrows between elements
		\draw[connections,solid] (latexindent) to[in=-90]node[pos=0.5,anchor=north]{1} (default.south) ;
		\draw[connections,optional] (latexindent) -- node[pos=0.5,anchor=north]{2} (indentconfig) ;
		\draw[connections,optional] (indentconfig) to[in=-90] (any.south) ;
		\draw[connections,optional] (indentconfig) -- (name) ;
		\draw[connections,optional] (indentconfig) to[out=-45,in=90] (you) ;
		\draw[connections,optional] (indentconfig) -- (want) ;
		\draw[connections,optional] (latexindent) -- node[pos=0.5,anchor=west]{3} (local) ;
	\end{tikzpicture}
	\caption{Schematic of the load order described in \cref{sec:loadorder}; solid lines represent
		mandatory files, dotted lines represent optional files. \texttt{indentconfig.yaml} can
		contain as many files as you like--the files will be loaded in order; if you specify
		settings for the same field in more than one file, the most recent takes priority. }
	\label{fig:loadorder}
\end{figure}

\section{The \texttt{-m} switch}\label{sec:modifylinebreaks}
\section{Known limitations}\label{sec:knownlimitations}

The following command struggles because of the []
%\strip_marks:n #1
%	{
%	\regex_replace_all:nnN { \c{marks}\cB\{ [^\}]* \cE\} } {  } \l_solution_text_tl
%	}

The following struggles:

%	\@ifnextchar[{\@assignmentwithcutoff}{\@assignmentnocutoff}

because of the unmatched [

There are a number of known limitations of the script, and almost certainly quite a
few that are \emph{unknown}!

The main limitation is to do with the alignment routine of environments that contain
delimiters--in other words, environments that are entered in \texttt{lookForAlignDelims}.
Indeed, this is the only part of the script that can \emph{potentially} remove
lines from \texttt{myfile.tex}. Note that \texttt{indent.log} will always
finish with a comparison of line counts before and after.

The routine works well for `standard' blocks of code that have the same number of \texttt{&}
per line, but it will not do anything for lines that do not--such examples
include \texttt{tabular} environments that use \texttt{\multicolumn} or
perhaps spread cell contents across multiple lines.  For each alignment block (\texttt{tabular},
\texttt{align}, etc) \texttt{latexindent.pl} first of all makes a record
of the maximum number of \texttt{&}; if each row does not have that
number of \texttt{&} then it will not try to format that row. Details
will be given in \texttt{indent.log} assuming that \texttt{trace} mode
is active.

If you have a \texttt{verbatim}-like environment inside a \texttt{tabular}-like
environment, the \texttt{verbatim} environment \emph{will} be formatted, which
is probably not what you want. I hope to address this in future versions, but for the
moment wrap it in a \texttt{noIndentBlock} (see \cpageref{lst:noIndentBlockdemo}).

You can run \texttt{latexindent} on \texttt{.sty}, \texttt{.cls} and any filetypes
that you specify in \lstinline[breaklines=true]!fileExtensionPreference! (see \vref{lst:fileExtensionPreference});
if you find a case in which the script struggles, please feel free
to report it at \cite{latexindent-home}, and
in the meantime, consider using a \texttt{noIndentBlock} (see \cpageref{lst:noIndentBlockdemo}).

I hope that this script is useful to some; if you find an example where the
script does not behave as you think it should, the best way to contact me is to
report an issue on \cite{latexindent-home}; otherwise, feel free to find me on
the \url{http://tex.stackexchange.com} site; I'm often around
and in the chat room.

\nocite{*}
\section{References}
\printbibliography[heading=subbibnumbered,title={External links},notkeyword=contributor]
\printbibliography[env=specialbib,heading=subbibnumbered,title={Contributors\label{sec:contributors}},keyword=contributor]

\appendix
\section{Required \texttt{Perl} modules}\label{sec:requiredmodules}
If you intend to use \texttt{latexindent.pl} and \emph{not} one of the supplied standalone executable files, then you will need a few standard Perl modules--if you can run the
minimum code in \cref{lst:helloworld} (\texttt{perl helloworld.pl}) then you will be able to run \texttt{latexindent.pl}, otherwise you may
need to install the missing modules.

\begin{cmhlistings}[language=Perl]{\texttt{helloworld.pl}}{lst:helloworld}
#!/usr/bin/perl

use strict;
use warnings;
use FindBin;
use YAML::Tiny;
use File::Copy;
use File::Basename;
use Getopt::Long;
use File::HomeDir;
use Data::UUID;

print "hello world";
exit;
\end{cmhlistings}
My default installation on Ubuntu 12.04 did \emph{not} come
with all of these modules as standard, but Strawberry Perl for Windows \cite{strawberryperl}
did.

Installing the modules given in \cref{lst:helloworld} will vary depending on your
operating system and \texttt{Perl} distribution. For example, Ubuntu users
might visit the software center, or else run
\begin{lstlisting}[numbers=none]
sudo perl -MCPAN -e 'install "File::HomeDir"'
\end{lstlisting}

Linux users may be interested in exploring Perlbrew \cite{perlbrew}; possible installation and setup
options follow for Ubuntu (other distributions will need slightly different commands).
\begin{lstlisting}[numbers=none]
sudo apt-get install perlbrew
perlbrew install perl-5.20.1
perlbrew switch perl-5.20.1
sudo apt-get install curl
curl -L http://cpanmin.us | perl - App::cpanminus
cpanm YAML::Tiny
cpanm File::HomeDir
use Data::UUID;
\end{lstlisting}

Strawberry Perl users on Windows might use
\texttt{CPAN client}. All of the modules are readily available on CPAN \cite{cpan}.

As of Version 2.1,  \texttt{indent.log} will contain details of the location
of the Perl modules on your system.  \texttt{latexindent.exe} is a standalone
executable for Windows (and therefore does not require a Perl distribution) and caches copies of the Perl modules onto your system; if you
wish to see where they are cached, use the  \texttt{trace} option, e.g  \texttt{latexindent.exe -t myfile.tex}.

\section{The \texttt{arara} rule}
The \texttt{arara} rule (\texttt{indent.yaml}) contains lines such as those
given in \cref{lst:arararule}. With this setup, the user \emph{always} has
to specify whether or not they want (in this example) to use the \texttt{trace}
identifier.
\begin{cmhlistings}[style=yaml,numbers=none]{The \texttt{arara} rule}{lst:arararule}
...
arguments:
- identifier: trace
  flag: <arara> @{ isTrue( parameters.trace, "-t" ) }
...
\end{cmhlistings}

If you would like to have the \texttt{trace} option on by default every time you
call \texttt{latexindent.pl} from \texttt{arara} (without having to write \texttt{% arara: indent: {trace: yes}}), then simply
amend \cref{lst:arararule} so that it looks like \cref{lst:arararulemod}.
\begin{cmhlistings}[style=yaml,numbers=none]{The \texttt{arara} rule (modified)}{lst:arararulemod}
...
arguments:
- identifier: trace
  flag: <arara> @{ isTrue( parameters.trace, "-t" ) }
  default: "-t"
...
\end{cmhlistings}

With this modification in place, you now simply to write \texttt{% arara: indent} and
\texttt{trace} mode will be activated by default. If you wish to turn off \texttt{trace}
mode then you can write \texttt{% arara: indent: {trace: off}}.

Of course, you can apply these types of modifications to \emph{any} of the identifiers,
but proceed with caution if you intend to do this for \texttt{overwrite}.

\section{Updating the \texttt{path} variable}\label{sec:updating-path}
\texttt{latexindent.pl} ships with a few scripts that can update the \texttt{path} variables
\footnote{Thanks to \cite{jasjuang} for this feature!}. If you're
on a Linux or Mac machine, then you'll want \texttt{CMakeLists.txt} from \cite{latexindent-home}.
\subsection{Add to path for Linux}
To add \texttt{latexindent.pl} to the path for Linux, follow these steps:
\begin{enumerate}
	\item download  \texttt{latexindent.pl}, \texttt{defaultSettings.yaml},  to your
	      chosen directory from \cite{latexindent-home} ;
	\item within your directory, create a directory called \texttt{path-helper-files} and
	      download \texttt{CMakeLists.txt} and \texttt{cmake_uninstall.cmake.in}
	      from \cite{latexindent-home}/path-helper-files to this directory;
	\item run \texttt{ls /usr/local/bin} to see what is \emph{currently} in there;
	\item run the commands given in \cref{linux-add-to-path};
	\item run \texttt{ls /usr/local/bin} again to check that \texttt{latexindent.pl} and \texttt{defaultSettings.yaml}
	      have been added.
\end{enumerate}
\begin{cmhlistings}[style=yaml,numbers=none]{Add to path from a Linux terminal}{linux-add-to-path}
sudo apt-get install cmake
sudo apt-get update && sudo apt-get install build-essential
mkdir build && cd build
cmake ../path-helper-files
sudo make install
\end{cmhlistings}
To \emph{remove} the files, run \texttt{sudo make uninstall}.
\subsection{Add to path for Windows}
To add \texttt{latexindent.exe} to the path for Windows, follow these steps:
\begin{enumerate}
	\item download  \texttt{latexindent.exe}, \texttt{defaultSettings.yaml},  \texttt{add-to-path.bat}
	      from \cite{latexindent-home} to your chosen directory;
	\item open a command prompt and run \texttt{echo %path%} to see what is \emph{currently} in your \texttt{%path%} variable;
	\item right click on \texttt{add-to-path.bat} and \emph{Run as administrator};
	\item log out, and log back in;
	\item open a command prompt and run \texttt{echo %path%} to check that the appropriate directory has been added to your
	      \texttt{%path%}.
\end{enumerate}
To \emph{remove} the directory from your \texttt{%path%}, run \texttt{remove-from-path.bat} as administrator.

\section{Differences from Version 2.1 to 3.0 (and beyond)}
There are a few (small) changes to the interface when comparing Version 2.1 to Version 3.0.
Explicitly, these are:
\begin{description}
	\item[OLD] \texttt{latexindent.pl -o myfile.tex outputfile.tex}
	\item[NEW] \texttt{latexindent.pl -o=outputfile.tex myfile.tex}

	\texttt{latexindent.pl -o outputfile.tex myfile.tex}
\end{description}

\section{The \texttt{-m} switch}\label{sec:m-switch}
\subsection{The phases of \texttt{latexindent.pl}}
latexindent.pl essentially has 3 phases:
\begin{enumerate}
	\item packing, in which code blocks are replaced with unique ids; if the -m switch is active, then during this phase,
	      \begin{itemize}
		      \item line breaks at the beginning of the \emph{body} can be added (BodyStartsOnOwnLine: 1) or removed (BodyStartsOnOwnLine: 0);
		      \item line breaks at the end of the body can be added (see EndStartsOnOwnLine: 1) or removed (see EndStartsOnOwnLine: 0);
		      \item NOTE: let's say that any key (such as, for example, BeginStartsOnOwnLine) is set to 1, and the
		            appropriate <thing> does already begin on its own line and is immediately preceeded by one or more blank line; in this situation,
		            the blank lines will \emph{not} be removed
	      \end{itemize}
	\item indentation, in which white space is added to the begin, body, and end statements;
	\item unpacking, in which unique ids are replaced by their \emph{indented} code blocks; if the -m switch is active, then during this phase,
	      \begin{itemize}
		      \item line breaks before \emph{begin} statements can be added or removed (if BeginStartsOnOwnLine==0);
		      \item line breaks after \emph{end} statements can be removed but \emph{NOT} added (see EndFinishesWithLineBreak).
	      \end{itemize}
\end{enumerate}
With these rules in mind, let's study a few test cases:

\fixthis{go into details about each of the following}
latexindent.pl environments-line-break-conflict.tex -s -t -m -o environments-line-break-conflict-mod1.tex -l=env-conflicts-mod1.yaml
latexindent.pl environments-line-break-conflict-nested.tex -s -t -m -o environments-line-break-conflict-nested-mod-2.tex -l=env-conflicts-mod2.yaml
latexindent.pl environments-line-break-conflict-nested.tex -s -t -m -o environments-line-break-conflict-nested-mod-3.tex -l=env-conflicts-mod3.yaml
environments-first-opt-args.tex, see all of the different examples in test-cases.sh
environments-second-opt-args.tex provides some interesting cases too

removeTrailingWhitespace:
beforeProcessing: 0
afterProcessing: 1

there is a difference between these two, especially when it comes to modifying line breaks.

For example, let's say that you have

%\end{something}****
my text

and you tell latexindent not to finish something with a linebreak; with beforeProcessing set to 0, then you'll receive:

%\end{something}****my text

and if you set beforeProcessing to 1, then you'll receive

%\end{something}my text

The \texttt{\fi} command knows to insert a space, so as to give, for example, \texttt{\fi} text, and avoid things such as \texttt{\fitext}

from yaml

\section{Moving from version 2.* to version 3.*}\label{sec:moving-version}
%# EVERYTHING BELOW HERE IS OBSOLETE IN V3.0  
%# EVERYTHING BELOW HERE IS OBSOLETE IN V3.0  
%# EVERYTHING BELOW HERE IS OBSOLETE IN V3.0  
%# *** NOTE ***
%# If you have specified alwaysLookforSplitBraces: 1
%# and alwaysLookforSplitBrackets: 1 then you don't need
%# to worry about completing
%#
%#       checkunmatched
%#       checkunmatchedELSE
%#       checkunmatchedbracket
%#
%# in other words, you don't really need to edit anything 
%# below this line- it used to be necessary for older 
%# versions of the script, but not anymore :)
%#***      ***
%#
%# always look for split { }, which means that the user doesn't
%# have to complete checkunmatched, checkunmatchedELSE
%
%# if you want to indent if, else, fi constructs such as, for example,
%#
%#       \ifnum#1=2
%#               something
%#       \else
%#               something else
%#       \fi
%#
%# then populate them in constructIfElseFi
%#
%# The following list is by no means exhaustive, but is taken from etex documentation;
%# add your own if commands to your own yaml settings.
%constructIfElseFi:
%    if: 1
%    ifcat: 1
%    ifnum: 1
%    ifdim: 1
%    ifodd: 1
%    ifvmode: 1
%    ifhmode: 1
%    ifmmode: 1
%    ifinner: 1
%    ifvoid: 1
%    ifhbox: 1
%    ifvbox: 1
%    ifx: 1
%    ifeof: 1
%    iftrue: 1
%    ifcase: 1
%    ifdefined: 1
%    ifcsname: 1
%    iffontchar: 1
%
%#noAdditionalIndent:
%#    \[: 0
%#    \]: 0
%
%alwaysLookforSplitBraces: 1
%
%# always look for split [ ], which means that the user doesn't
%# have to complete checkunmatchedbracket
%alwaysLookforSplitBrackets: 1
%
%
%# commands that might split {} across lines
%# such as \parbox, \marginpar, etc
%checkunmatched:
%    parbox: 1
%    vbox: 1
%
%# very similar to %checkunmatched except these 
%# commands might have an else construct
%checkunmatchedELSE:
%    pgfkeysifdefined: 1
%    DTLforeach: 1
%    ifthenelse: 1
%
%# commands that might split []  across lines
%# such as \pgfplotstablecreatecol, etc
%checkunmatchedbracket:
%    pgfplotstablecreatecol: 1
%    pgfplotstablesave: 1
%    pgfplotstabletypeset: 1
%    mycommand: 1
%    psSolid: 1
%
% OLD
%indentAfterHeadings:
%    part:
%       indent: 0
%       level: 1
% NEW:
%indentAfterHeadings:
%    part:
%       indentAfterThisHeading: 0
%       level: 1


\end{document}
