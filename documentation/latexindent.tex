% arara: pdflatex: {shell: yes}
% !arara: pdflatex: {shell: yes}
% !arara: bibtex
% !arara: pdflatex
% !arara: pdflatex
% !arara: pdflatex
% !arara: indent: {overwrite: yes, trace: yes, localSettings: yes, silent: yes}
\documentclass[10pt]{article}
%   This program is free software: you can redistribute it and/or modify
%   it under the terms of the GNU General Public License as published by
%   the Free Software Foundation, either version 3 of the License, or
%   (at your option) any later version.
%
%   This program is distributed in the hope that it will be useful,
%   but WITHOUT ANY WARRANTY; without even the implied warranty of
%   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%   GNU General Public License for more details.
%
%   See <http://www.gnu.org/licenses/>.
\usepackage[left=4.5cm,right=2.5cm,showframe=false,
	top=2cm,bottom=1.5cm]{geometry}                      % page setup
\usepackage{lmodern}
\usepackage{parskip}                                 % paragraph skips
\usepackage{booktabs}                                % beautiful tables
\usepackage{listings}                                % nice verbatim environments
\usepackage{titlesec}                                % customize headings
\usepackage{changepage}                              % adjust width of page
\usepackage{fancyhdr}                                % headers & footers
\usepackage{wrapfig}
\usepackage[sc,format=hang,font=small]{caption}      % captions
\usepackage[backend=bibtex]{biblatex}                % bibliography
\usepackage{tcolorbox}                                % framed environments
\usepackage{xparse}
\usepackage[charter]{mathdesign}                     % changes font
\usepackage[expansion=false,kerning=true]{microtype} % better kerning
\usepackage{enumitem}                                % custom lists
% setup gitinfo2, as in the manual, details just above begin{document}
\usepackage[mark,grumpy]{gitinfo2}
% tcolorbox libraries
\tcbuselibrary{breakable,skins,listings,minted,xparse}
%\usepackage{varioref}                                % clever referencing
%\tcbuselibrary{documentation,breakable,skins,minted}
% tikz libraries
\usetikzlibrary{positioning}
\usetikzlibrary{decorations.pathmorphing}
\usetikzlibrary{decorations,shapes}
\usepackage{varioref}                                % clever referencing
\usepackage{hyperref}
\hypersetup{
	pdfauthor={Chris Hughes},
	pdftitle={latexindent.pl package},
	pdfkeywords={perl;beautify;indentation},
	bookmarksnumbered,
	bookmarksopen,
	linktocpage,
	colorlinks=true,
	linkcolor=blue,
	citecolor=black,
}
\usepackage{cleveref}

\addbibresource{latex-indent}
\addbibresource{contributors}


% http://tex.stackexchange.com/questions/122135/how-to-add-a-png-icon-on-the-right-side-of-a-tcolorbox-title
\newtcolorbox{warning}{parbox=false,breakable,enhanced,arc=0mm,colback=red!5,colframe=red,leftrule=12mm,%
overlay={\node[anchor=north west,outer sep=2pt] at (frame.north west) {\includegraphics[width=8mm]{warning}}; }
}

\definecolor{harvestgold}{cmyk}{0.00, 0.05, 0.51, 0.07}  %EDE275
\definecolor{cmhgold}{cmyk}{0,0.178,0.909,0.008}         %FDD017
\makeatletter
\tcbset{
	addtolol/.style={list entry={\kvtcb@title},add to list={lol}{lstlisting}},
	cmhlistings/.style={
			%	width=\linewidth,
			%breakable,
			colback=blue!5!white,
			colframe=white!85!black,
			top=0cm,
			bottom=0cm,
			left=0mm,
			listing only,
			center title,
			listing engine=minted,
			minted style=colorful,
			addtolol,
			boxrule=0pt,
			toprule=1pt,bottomrule=1pt,
			titlerule=1pt,
			colframe=white!25!black,colback=white,
			sharp corners,
			colbacktitle=white!75!black,
		},
	yaml-TCB/.style={
			listing only,
			listing engine=listings,
			left=0cm,
			boxrule=0pt,
			%leftrule=3pt,
			sharp corners,
			center title,
            %colbacktitle=white!75!black,
			colbacktitle=white,
			colframe=white!25!black,colback=white,
            toprule=2pt,
            titlerule=2pt,
		},
    MLB-TCB/.style={
            enhanced,
			listing only,
			listing engine=listings,
			left=0cm,
			boxrule=0pt,
			sharp corners,
			center title,
            colframe=cmhgold,
			colbacktitle=harvestgold,
            titlerule=2pt,
            toprule=2pt,
            width=0.9\linewidth,
            before=\centering,
            %overlay={\node[anchor=north east,outer sep=2pt] at ([xshift=8mm]frame.north east) {\includegraphics[width=8mm]{logo}}; }
    }
}

\newtcblisting[use counter=lstlisting]{cmhlistings}[3][]{%
	cmhlistings,
	center title,
	title={\color{black}{\scshape Listing \thetcbcounter}: ~#2},label={#3},
	listing engine=listings,
	listing options={#1},
}

\DeclareTCBInputListing[use counter=lstlisting]{\cmhlistingsfromfile}{O{} m O{} m m}{%
	cmhlistings,
	listing file={#2},
	listing options={#1},
	title={\color{black}{\scshape Listing \thetcbcounter}: ~#4},label={#5},
	#3,
}

% command shell
\newtcblisting{commandshell}{colback=black,colupper=white,colframe=yellow!75!black,
	listing only,listing options={style=tcblatex,language=sh,
			morekeywords={latexindent,pl},
			keywordstyle=\color{blue!35!white}\bfseries,
		},
	listing engine=listings,
	left=0cm,
	every listing line={\textcolor{red}{\small\ttfamily\fontseries{b}\selectfont cmh:$\sim$\$ }}}


\lstset{%
	basicstyle=\small\ttfamily,language={[LaTeX]TeX},
	%	numbers=left,
	numberstyle=\ttfamily%\small,
	breaklines=true,
	%   frame=single,framexleftmargin=8mm, xleftmargin=8mm,
	%	prebreak = \raisebox{0ex}[0ex][0ex]{\ensuremath{\hookrightarrow}},
	%	backgroundcolor=\color{green!5},frameround=fttt,
	%	rulecolor=\color{blue!70!black},
	keywordstyle=\color{blue},                    % keywords
	commentstyle=\color{purple},    % comments
	tabsize=3,
	%xleftmargin=1.5em,
}%
\DeclareTCBListing[use counter=lstlisting]{yaml}{O{} m O{} m}{
	yaml-TCB,
	listing options={
			style=tcblatex,
			numbers=left,
			numberstyle=\color{red},
			#1,
		},
	title={\color{black}{\scshape Listing \thetcbcounter}: ~#2},label={#4},
	#3,
}

\lstdefinestyle{yaml-LST}{
	style=tcblatex,
	numbers=none,
	%numbers=left,
	numberstyle=\color{red},
}

\lstdefinestyle{demo}{
	numbers=none,
	linewidth=1.25\textwidth,
	columns=fullflexible,
}



% stars around contributors
\pgfdeclaredecoration{stars}{initial}{
	\state{initial}[width=15pt]
	{
		\pgfmathparse{round(rnd*100)}
		\pgfsetfillcolor{yellow!\pgfmathresult!orange}
		\pgfsetstrokecolor{yellow!\pgfmathresult!red}
		\pgfnode{star}{center}{}{}{\pgfusepath{stroke,fill}}
	}
	\state{final}
	{
		\pgfpathmoveto{\pgfpointdecoratedpathlast}
	}
}

\newtcolorbox{stars}{%
enhanced jigsaw,
breakable, % allow page breaks
left=0cm,
top=0cm,
before skip=0.2cm,
boxsep=0cm,
frame style={draw=none,fill=none}, % hide the default frame
colback=white,
overlay={
\draw[inner sep=0,minimum size=rnd*15pt+2pt]
decorate[decoration={stars,segment length=2cm}] {
decorate[decoration={zigzag,segment length=2cm,amplitude=0.3cm}] {
([xshift=-.5cm,yshift=0.1cm]frame.south west) --  ([xshift=-.5cm,yshift=0.4cm]frame.north west)
}};
\draw[inner sep=0,minimum size=rnd*15pt+2pt]
decorate[decoration={stars,segment length=2cm}] {
decorate[decoration={zigzag,segment length=2cm,amplitude=0.3cm}] {
([xshift=.75cm,yshift=0.1cm]frame.south east) --  ([xshift=.75cm,yshift=0.6cm]frame.north east)
}};
},
% paragraph skips obeyed within tcolorbox
parbox=false,
}

% copied from /usr/local/texlive/2013/texmf-dist/tex/latex/biblatex/bbx/numeric.bbx
% the only modification is the \stars and \endstars
\defbibenvironment{specialbib}
{\stars\list
	{\printtext[labelnumberwidth]{%
			\printfield{prefixnumber}%
			\printfield{labelnumber}}}
	{\setlength{\labelwidth}{\labelnumberwidth}%
		\setlength{\leftmargin}{\labelwidth}%
		\setlength{\labelsep}{\biblabelsep}%
		\addtolength{\leftmargin}{\labelsep}%
		\setlength{\itemsep}{\bibitemsep}%
		\setlength{\parsep}{\bibparsep}}%
	\renewcommand*{\makelabel}[1]{\hss##1}}
{\endlist\endstars}
{\item}

\newtcbox{yamltitlebox}[1][]{colframe=black!50!white,boxrule=.5pt,sharp corners,#1}

\newcommand{\flagbox}[1]{%
	\par
	\makebox[30pt][l]{%
		\hspace{-2cm}%
		\ttfamily\fontseries{b}\selectfont #1
	}%
}

\NewDocumentCommand{\yamltitle}{O{} m s m}{%
	\par
	\makebox[30pt][l]{%
		\hspace{-2cm}%
		\yamltitlebox[#1]{%
				{\ttfamily\fontseries{b}\selectfont{\color{blue!80!white}#2}}: %
			\IfBooleanTF{#3}
			{$\langle$\itshape #4$\rangle$}
			{{\bfseries #4}}
		}}
	\par\nobreak%
}

\newcommand{\fixthis}[1]
{%
	\marginpar{\huge \color{red} \framebox{FIX}}%
	\typeout{FIXTHIS: p\thepage : #1^^J}%
}
% custom section
\titleformat{\section}
{\normalfont\Large\bfseries}
{\llap{\thesection\hskip.5cm}}
{0pt}
{}
% custom subsection
\titleformat{\subsection}
{\normalfont\bfseries}
{\llap{\thesubsection\hskip.5cm}}
{0pt}
{}
% custom subsubsection
\titleformat{\subsubsection}
{\normalfont\bfseries}
{\llap{\thesubsubsection\hskip.5cm}}
{0pt}
{}


\titlespacing\section{0pt}{12pt plus 4pt minus 2pt}{-5pt plus 2pt minus 2pt}
\titlespacing\subsection{0pt}{12pt plus 4pt minus 2pt}{-6pt plus 2pt minus 2pt}
\titlespacing\subsubsection{0pt}{12pt plus 4pt minus 2pt}{-6pt plus 2pt minus 2pt}


% cleveref settings
\crefname{table}{Table}{Tables}
\Crefname{table}{Table}{Tables}
\crefname{figure}{Figure}{Figures}
\Crefname{figure}{Figure}{Figures}
\crefname{section}{Section}{Sections}
\Crefname{section}{Section}{Sections}
\crefname{listing}{Listing}{Listings}
\Crefname{listing}{Listing}{Listings}

% headers and footers
\fancyhf{} % delete current header and footer
\fancyhead[R]{\bfseries\thepage%
\tikz[remember picture,overlay] {
\node at (1,0){\includegraphics{logo-bw}}; }
}
\fancyheadoffset[L]{3cm}
\pagestyle{fancy}

% renew plain style
\fancypagestyle{plain}{%
	\fancyhf{} % clear all header and footer fields
	\renewcommand{\headrulewidth}{0pt}
	\renewcommand{\footrulewidth}{0pt}}

% sidebyside environment
\newenvironment{sidebyside}{\begin{adjustwidth}{-3cm}{0cm}}{\end{adjustwidth}}

% symbols for the m switch
\newcommand{\BeginStartsOnOwnLine}{\color{red}\spadesuit}
\newcommand{\BodyStartsOnOwnLine}{\color{red}\heartsuit}
\newcommand{\EndStartsOnOwnLine}{\color{red}\diamondsuit}
\newcommand{\EndFinishesWithLineBreak}{\color{red}\clubsuit}

% gitinfo2 settings
\renewcommand{\gitMark}{\gitBranch\,@\,\gitAbbrevHash{}\,\textbullet{}\,\gitAuthorDate}

% setting up gitinfo2:
%   copy the file post-xxx-sample.txt from http://mirror.ctan.org/macros/latex/contrib/gitinfo2
%   and put it in .git/hooks/post-checkout
% then
%   cd .git/hooks
%   chmod g+x post-checkout
%   chmod +x post-checkout
%   cp post-checkout post-commit
%   cp post-checkout post-merge
%   cd ../..
%   git checkout master
%   git checkout develop
%   ls .git
% and you should see gitHeadInfo.gin
\begin{document}
% \begin{noindent}
\title{\ttfamily\bfseries latexindent.pl\\[1cm] Version 3.0}
% \end{noindent}
\author{Chris Hughes \footnote{and contributors! (See \vref{sec:contributors}.) For
		all communication, please visit \cite{latexindent-home}.}}
\maketitle
\begin{abstract}
	\texttt{latexindent.pl} is a \texttt{Perl} script that indents \texttt{.tex} (and other)
	files according to an indentation scheme that the user can modify to suit their
	taste. Environments, including those with alignment delimiters (such as \texttt{tabular}),
	and commands, including those that can split braces and brackets across lines,
	are \emph{usually} handled correctly by the script. Options for \texttt{verbatim}-like
	environments and indentation after headings (such as \lstinline!chapter!, \lstinline!section!, etc)
	are also available. The script also has the ability to modifiy line breaks, and add
	comment symbols.
\end{abstract}
\tableofcontents
\lstlistoflistings

%\input{sec-introduction}
%\input{sec-demonstration}
%\input{sec-how-to-use}
%\input{sec-default-user-local}
%\input{subsec-noAdditionalIndent-indentRules}
%\input{subsubsec-environments-and-their-arguments}
%\input{subsubsec-environments-with-items}
%\input{subsubsec-commands-with-arguments}
%\input{subsubsec-ifelsefi}
%\input{subsubsec-special}
\input{sec-the-m-switch}
\end{document}

%    # set noAdditionalIndent globally for codeblocks
%    noAdditionalIndentGlobal:
%        environments: 0
%        commands: 1
%        optionalArguments: 0
%        mandatoryArguments: 0
%        ifElseFi: 0
%        items: 0

This specifies noAdditionalIndent globally for code blocks;

%# set indentRules globally for codeblocks; these need 
%# to be horizontal spaces, if they are to be used
%indentRulesGlobal:
%    environments: 0
%    commands: 0
%    optionalArguments: 0
%    mandatoryArguments: 0
%    ifElseFi: 0
%    items: 0

The hierachy is
\begin{enumerate}
	\item noAdditionalIndent (on a per-name basis)
	\item indentRules (on a per-name basis)
	\item noAdditionalIndentGlobal
	\item indentRulesGlobal
	\item defaultIndent
\end{enumerate}

\item[\verbitem{logFilePreferences}]
\texttt{latexindent.pl} writes information to \texttt{indent.log}, some
of which can be customised by changing \texttt{logFilePreferences}; see \cref{lst:logFilePreferences}.
\begin{cmhlistings}[style=yaml]{\texttt{logFilePreferences}}{lst:logFilePreferences}
	logFilePreferences:
	logFileName: "indent.log"
	showEveryYamlRead: 1
	showAmalgamatedSettings: 0
	endLogFileWith: '--------------'
\end{cmhlistings}
You can customize the name of your logfile to anything you like by changing \texttt{logFileName}.
If you load your own user settings (see \vref{sec:indentconfig}) then \texttt{latexindent.pl} will
detail them in \texttt{indent.log}; you can choose not to have the details logged by switching
\texttt{showEveryYamlRead} to \texttt{0}. Once all of your settings have
been loaded, you can see the amalgamated settings by switching \texttt{showAmalgamatedSettings}
to \texttt{1}, if you wish. The log file will end with the characters
given in \texttt{endLogFileWith}.

\subsubsection{Hierarchy of fields}\label{sec:fieldhierachy}
After reading the previous section, it should sound reasonable that
\texttt{noAdditionalIndent}, \texttt{indentRules}, and
\texttt{verbatim} all serve mutually exclusive tasks. Naturally, you may
well wonder what happens if you choose to ask \texttt{latexindent.pl} to
prioritize one above the other.

For example, let's say that (after reading \cref{sec:indentconfig}) you put the fields in \cref{lst:conflict} into
one of your settings files.
\begin{cmhlistings}[style=yaml]{Conflicting ideas}{lst:conflict}
	indentRules:
	myenvironment: "\t\t"
	noAdditionalIndent:
	myenvironment: 1
\end{cmhlistings}

Clearly these fields conflict: first of all
you are telling \texttt{latexindent.pl} that \texttt{myenvironment} should
receive two tabs of indentation, and then you are telling it
not to put any indentation in the environment. \texttt{latexindent.pl}
will always make the decision to prioritize \texttt{noAdditionalIndent} above
\texttt{indentRules} regardless of the order that you load them in
your settings file. The first
time it encounters \texttt{myenvironment} it will put a warning in \texttt{indent.log}
and delete the offending key from \texttt{indentRules} so that any future
conflicts will not have to be addressed.

Let's consider another conflicting example in \cref{lst:bigconflict}
\begin{cmhlistings}[style=yaml]{More conflicting ideas}{lst:bigconflict}
	lookForAlignDelims:
	myenvironment: 1
	verbatimEnvironments:
	myenvironment: 1
\end{cmhlistings}
This is quite a significant conflict--we are first of all telling \texttt{latexindent.pl}
to look for alignment delimiters in \texttt{myenvironment} and then
telling it that actually we would like \texttt{myenvironment} to be considered
as a \texttt{verbatim}-like environment. Regardless of the order that we
state \cref{lst:bigconflict} the \texttt{verbatim} instruction will always win.
As in \cref{lst:conflict} you will only receive a warning in \texttt{indent.log} the
first time \texttt{latexindent.pl} encounters \texttt{myenvironment} as the
offending key is deleted from \texttt{lookForAlignDelims}.

To summarize, \texttt{latexindent.pl} will prioritize the various fields in the
following order:
\begin{enumerate}
	\item \texttt{verbatimEnvironments}
	\item \texttt{noAdditionalIndent}
	\item \texttt{indentRules}
\end{enumerate}
\subsection{\texttt{indentconfig.yaml} and \texttt{.indentconfig.yaml} (for user settings)}\label{sec:indentconfig}
Editing \texttt{defaultSettings.yaml} is not ideal as it may be overwritten when
updating your distribution--a better way to customize the settings to your liking
is to set up your own settings file,
\texttt{mysettings.yaml} (or any name you like, provided it ends with \texttt{.yaml}).
The only thing you have to do is tell \texttt{latexindent.pl} where to find it.

\texttt{latexindent.pl} will always check your home directory for \texttt{indentconfig.yaml}
and  \texttt{.indentconfig.yaml} (unless
it is called with the \texttt{-d} switch),
which is a plain text file you can create that contains the \emph{absolute}
paths for any settings files that you wish \texttt{latexindent.pl} to load. There is no difference
between \texttt{indentconfig.yaml} and \texttt{.indentconfig.yaml}, other than the
fact that \texttt{.indentconfig.yaml} is a `hidden' file; thank you to \cite{jacobo-diaz-hidden-config}
for providing this feature. In what follows, we will use \texttt{indentconfig.yaml}, but it
is understood that this equally represents \texttt{.indentconfig.yaml} as well. If you
have both files in existence,  \texttt{indentconfig.yaml} takes priority.

For Mac and Linux users, their home directory is \texttt{~/username} while
Windows (Vista onwards) is \texttt{C:\Users\username} \footnote{If you're not sure
	where to put \texttt{indentconfig.yaml}, don't
	worry \texttt{latexindent.pl} will tell you in the log file exactly where to
	put it assuming it doesn't exist already.}
\Cref{lst:indentconfig} shows a sample \texttt{indentconfig.yaml} file.

\begin{cmhlistings}[style=yaml]{\texttt{indentconfig.yaml} (sample)}{lst:indentconfig}
	# Paths to user settings for latexindent.pl
	#
	# Note that the settings will be read in the order you
	# specify here- each successive settings file will overwrite
	# the variables that you specify

	paths:
	- /home/cmhughes/Documents/yamlfiles/mysettings.yaml
	- /home/cmhughes/folder/othersettings.yaml
	- /some/other/folder/anynameyouwant.yaml
	- C:\Users\chughes\Documents\mysettings.yaml
	- C:\Users\chughes\Desktop\test spaces\more spaces.yaml
\end{cmhlistings}

Note that the \texttt{.yaml} files you specify in \texttt{indentconfig.yaml}
will be loaded in the order that you write them in. Each file doesn't have
to have every switch from \texttt{defaultSettings.yaml}; in fact, I recommend
that you only keep the switches that you want to \emph{change} in these
settings files.

To get started with your own settings file, you might like to save a copy of
\texttt{defaultSettings.yaml} in another directory and call it, for
example, \texttt{mysettings.yaml}. Once you have added the path to \texttt{indentconfig.yaml}
feel free to start changing the switches and adding more environments to it
as you see fit--have a look at \cref{lst:mysettings} for an example
that uses four tabs for the default indent, adds the \texttt{tabbing}
environment to the list of environments that contains alignment delimiters,
and adds the changes we described on \cpageref{page:examsettings}.

\begin{cmhlistings}[style=yaml]{\texttt{mysettings.yaml} (example)}{lst:mysettings}
	# Default value of indentation
	defaultIndent: "\t\t\t\t"

	# environments that have tab delimiters, add more
	# as needed
	lookForAlignDelims:
	tabbing: 1

	# If you use the exam documentclass, you might
	# like the following settings
	# environments that have \item commands
	indentAfterItems:
	parts: 1

	# commands to be treated like \item
	itemNames:
	part: 1
\end{cmhlistings}

You can make sure that your settings are loaded by checking \texttt{indent.log}
for details--if you have specified a path that \texttt{latexindent.pl} doesn't
recognize then you'll get a warning, otherwise you'll get confirmation that
\texttt{latexindent.pl} has read your settings file \footnote{Windows users
	may find that they have to end \texttt{.yaml} files with a blank line}.

\begin{warning}
	When editing \texttt{.yaml} files it is \emph{extremely} important
	to remember how sensitive they are to spaces. I highly recommend copying
	and pasting from \texttt{defaultSettings.yaml} when you create your
	first \texttt{whatevernameyoulike.yaml} file.

	If \texttt{latexindent.pl} can not read your \texttt{.yaml} file it
	will tell you so in \texttt{indent.log}.
\end{warning}

\subsection{\texttt{localSettings.yaml}}\label{sec:localsettings}
You may remember on \cpageref{page:localswitch} we discussed the \texttt{-l} switch
that tells \texttt{latexindent.pl} to look for \texttt{localSettings.yaml} in the
\emph{same directory} as \texttt{myfile.tex}. This settings file will
be read \emph{after} \texttt{defaultSettings.yaml} and, assuming they exist,
user settings.

The \emph{local} settings file may be called \texttt{localSettings.yaml}, and
it can contain any switches that you'd
like to change--a sample is shown in \cref{lst:localSettings}.

\begin{cmhlistings}[style=yaml]{\texttt{localSettings.yaml} (example)}{lst:localSettings}
	# Default value of indentation
	defaultIndent: " "

	# environments that have tab delimiters, add more
	# as needed
	lookForAlignDelims:
	tabbing: 0

	#  verbatim environments- environments specified
	#  in this hash table will not be changed at all!
	verbatimEnvironments:
	cmhenvironment: 0
\end{cmhlistings}

\fixthis{expand on this!}

You can make sure that your local settings are loaded by checking \texttt{indent.log}
for details--if \texttt{localSettings.yaml} can not be read then you will
get a warning, otherwise you'll get confirmation that
\texttt{latexindent.pl} has read \texttt{localSettings.yaml}.

If you'd prefer to name your \texttt{localSettings.yaml} file something different, (say, \texttt{myyaml.yaml}) then
you can call \texttt{latexindent.pl} using, for example, \lstinline[breaklines=true]!latexindent.pl -l=myyaml.yaml myfile.tex!.

\subsection{Settings load order}\label{sec:loadorder}
\texttt{latexindent.pl} loads the settings files in the following order:
\begin{enumerate}
	\item \texttt{defaultSettings.yaml} is always loaded, and can not be renamed;
	\item \texttt{anyUserSettings.yaml} and any other arbitrarily-named files specified in \texttt{indentconfig.yaml};
	\item \texttt{localSettings.yaml} but only if found in the same directory as \texttt{myfile.tex} and called
	      with \texttt{-l} switch; this file can be renamed, provided that the call to \texttt{latexindent.pl} is adjusted
	      accordingly (see \cref{sec:localsettings}).
\end{enumerate}
A visual representation of this is given in \cref{fig:loadorder}.

\begin{figure}
	\centering
	\begin{tikzpicture}[
			needed/.style={very thick, draw=blue,fill=blue!20,
					text centered, minimum height=2.5em,rounded corners=1ex},
			optional/.style={draw=black, very thick,scale=0.8,
					text centered, minimum height=2.5em,rounded corners=1ex},
			optionalfill/.style={fill=black!10},
			connections/.style={draw=black!30,dotted,line width=3pt,text=red},
		]
		% Draw diagram elements
		\node (latexindent) [needed,circle]  {\texttt{latexindent.pl}};
		\node (default) [needed,above right=.5cm of latexindent]  {\texttt{defaultSettings.yaml}};
		\node (indentconfig) [optional,right=of latexindent]  {\texttt{indentconfig.yaml}};
		\node (any) [optional,optionalfill,above right=of indentconfig]  {\texttt{any.yaml}};
		\node (name) [optional,optionalfill,right=of indentconfig]  {\texttt{name.yaml}};
		\node (you) [optional,optionalfill,below right=of indentconfig]  {\texttt{you.yaml}};
		\node (want) [optional,optionalfill,below=of indentconfig]  {\texttt{want.yaml}};
		\node (local) [optional,below=of latexindent]  {\texttt{localSettings.yaml}};
		% Draw arrows between elements
		\draw[connections,solid] (latexindent) to[in=-90]node[pos=0.5,anchor=north]{1} (default.south) ;
		\draw[connections,optional] (latexindent) -- node[pos=0.5,anchor=north]{2} (indentconfig) ;
		\draw[connections,optional] (indentconfig) to[in=-90] (any.south) ;
		\draw[connections,optional] (indentconfig) -- (name) ;
		\draw[connections,optional] (indentconfig) to[out=-45,in=90] (you) ;
		\draw[connections,optional] (indentconfig) -- (want) ;
		\draw[connections,optional] (latexindent) -- node[pos=0.5,anchor=west]{3} (local) ;
	\end{tikzpicture}
	\caption{Schematic of the load order described in \cref{sec:loadorder}; solid lines represent
		mandatory files, dotted lines represent optional files. \texttt{indentconfig.yaml} can
		contain as many files as you like--the files will be loaded in order; if you specify
		settings for the same field in more than one file, the most recent takes priority. }
	\label{fig:loadorder}
\end{figure}

\section{Known limitations}\label{sec:knownlimitations}

The following command struggles because of the []
%\strip_marks:n #1
%	{
%	\regex_replace_all:nnN { \c{marks}\cB\{ [^\}]* \cE\} } {  } \l_solution_text_tl
%	}

The following struggles:

%	\@ifnextchar[{\@assignmentwithcutoff}{\@assignmentnocutoff}

because of the unmatched [

There are a number of known limitations of the script, and almost certainly quite a
few that are \emph{unknown}!

The main limitation is to do with the alignment routine of environments that contain
delimiters--in other words, environments that are entered in \texttt{lookForAlignDelims}.
Indeed, this is the only part of the script that can \emph{potentially} remove
lines from \texttt{myfile.tex}. Note that \texttt{indent.log} will always
finish with a comparison of line counts before and after.

The routine works well for `standard' blocks of code that have the same number of \texttt{&}
per line, but it will not do anything for lines that do not--such examples
include \texttt{tabular} environments that use \texttt{\multicolumn} or
perhaps spread cell contents across multiple lines.  For each alignment block (\texttt{tabular},
\texttt{align}, etc) \texttt{latexindent.pl} first of all makes a record
of the maximum number of \texttt{&}; if each row does not have that
number of \texttt{&} then it will not try to format that row. Details
will be given in \texttt{indent.log} assuming that \texttt{trace} mode
is active.

If you have a \texttt{verbatim}-like environment inside a \texttt{tabular}-like
environment, the \texttt{verbatim} environment \emph{will} be formatted, which
is probably not what you want. I hope to address this in future versions, but for the
moment wrap it in a \texttt{noIndentBlock} (see \cpageref{lst:noIndentBlockdemo}).

You can run \texttt{latexindent} on \texttt{.sty}, \texttt{.cls} and any filetypes
that you specify in \lstinline[breaklines=true]!fileExtensionPreference! (see \vref{lst:fileExtensionPreference});
if you find a case in which the script struggles, please feel free
to report it at \cite{latexindent-home}, and
in the meantime, consider using a \texttt{noIndentBlock} (see \cpageref{lst:noIndentBlockdemo}).

I hope that this script is useful to some; if you find an example where the
script does not behave as you think it should, the best way to contact me is to
report an issue on \cite{latexindent-home}; otherwise, feel free to find me on
the \url{http://tex.stackexchange.com} site; I'm often around
and in the chat room.

\nocite{*}
\section{References}
\printbibliography[heading=subbibnumbered,title={External links},notkeyword=contributor]
\printbibliography[env=specialbib,heading=subbibnumbered,title={Contributors\label{sec:contributors}},keyword=contributor]

\appendix
\section{Required \texttt{Perl} modules}\label{sec:requiredmodules}
If you intend to use \texttt{latexindent.pl} and \emph{not} one of the supplied standalone executable files, then you will need a few standard Perl modules--if you can run the
minimum code in \cref{lst:helloworld} (\texttt{perl helloworld.pl}) then you will be able to run \texttt{latexindent.pl}, otherwise you may
need to install the missing modules.

\begin{cmhlistings}[language=Perl]{\texttt{helloworld.pl}}{lst:helloworld}
	#!/usr/bin/perl

	use strict;
	use warnings;
	use FindBin;
	use YAML::Tiny;
	use File::Copy;
	use File::Basename;
	use Getopt::Long;
	use File::HomeDir;
	use Data::UUID;

	print "hello world";
	exit;
\end{cmhlistings}
My default installation on Ubuntu 12.04 did \emph{not} come
with all of these modules as standard, but Strawberry Perl for Windows \cite{strawberryperl}
did.

Installing the modules given in \cref{lst:helloworld} will vary depending on your
operating system and \texttt{Perl} distribution. For example, Ubuntu users
might visit the software center, or else run
\begin{lstlisting}[numbers=none]
sudo perl -MCPAN -e 'install "File::HomeDir"'
\end{lstlisting}

Linux users may be interested in exploring Perlbrew \cite{perlbrew}; possible installation and setup
options follow for Ubuntu (other distributions will need slightly different commands).
\begin{lstlisting}[numbers=none]
sudo apt-get install perlbrew
perlbrew install perl-5.20.1
perlbrew switch perl-5.20.1
sudo apt-get install curl
curl -L http://cpanmin.us | perl - App::cpanminus
cpanm YAML::Tiny
cpanm File::HomeDir
use Data::UUID;
\end{lstlisting}

Strawberry Perl users on Windows might use
\texttt{CPAN client}. All of the modules are readily available on CPAN \cite{cpan}.

As of Version 2.1,  \texttt{indent.log} will contain details of the location
of the Perl modules on your system.  \texttt{latexindent.exe} is a standalone
executable for Windows (and therefore does not require a Perl distribution) and caches copies of the Perl modules onto your system; if you
wish to see where they are cached, use the  \texttt{trace} option, e.g  \texttt{latexindent.exe -t myfile.tex}.

\section{The \texttt{arara} rule}
The \texttt{arara} rule (\texttt{indent.yaml}) contains lines such as those
given in \cref{lst:arararule}. With this setup, the user \emph{always} has
to specify whether or not they want (in this example) to use the \texttt{trace}
identifier.
\begin{cmhlistings}[style=yaml,numbers=none]{The \texttt{arara} rule}{lst:arararule}
	...
	arguments:
	- identifier: trace
	flag: <arara> @{ isTrue( parameters.trace, "-t" ) }
	...
\end{cmhlistings}

If you would like to have the \texttt{trace} option on by default every time you
call \texttt{latexindent.pl} from \texttt{arara} (without having to write \texttt{% arara: indent: {trace: yes}}), then simply
amend \cref{lst:arararule} so that it looks like \cref{lst:arararulemod}.
\begin{cmhlistings}[style=yaml,numbers=none]{The \texttt{arara} rule (modified)}{lst:arararulemod}
	...
	arguments:
	- identifier: trace
	flag: <arara> @{ isTrue( parameters.trace, "-t" ) }
	default: "-t"
	...
\end{cmhlistings}

With this modification in place, you now simply to write \texttt{% arara: indent} and
\texttt{trace} mode will be activated by default. If you wish to turn off \texttt{trace}
mode then you can write \texttt{% arara: indent: {trace: off}}.

Of course, you can apply these types of modifications to \emph{any} of the identifiers,
but proceed with caution if you intend to do this for \texttt{overwrite}.

\section{Updating the \texttt{path} variable}\label{sec:updating-path}
\texttt{latexindent.pl} ships with a few scripts that can update the \texttt{path} variables
\footnote{Thanks to \cite{jasjuang} for this feature!}. If you're
on a Linux or Mac machine, then you'll want \texttt{CMakeLists.txt} from \cite{latexindent-home}.
\subsection{Add to path for Linux}
To add \texttt{latexindent.pl} to the path for Linux, follow these steps:
\begin{enumerate}
	\item download  \texttt{latexindent.pl}, \texttt{defaultSettings.yaml},  to your
	      chosen directory from \cite{latexindent-home} ;
	\item within your directory, create a directory called \texttt{path-helper-files} and
	      download \texttt{CMakeLists.txt} and \texttt{cmake_uninstall.cmake.in}
	      from \cite{latexindent-home}/path-helper-files to this directory;
	\item run \texttt{ls /usr/local/bin} to see what is \emph{currently} in there;
	\item run the commands given in \cref{linux-add-to-path};
	\item run \texttt{ls /usr/local/bin} again to check that \texttt{latexindent.pl} and \texttt{defaultSettings.yaml}
	      have been added.
\end{enumerate}
\begin{cmhlistings}[style=yaml,numbers=none]{Add to path from a Linux terminal}{linux-add-to-path}
	sudo apt-get install cmake
	sudo apt-get update && sudo apt-get install build-essential
	mkdir build && cd build
	cmake ../path-helper-files
	sudo make install
\end{cmhlistings}
To \emph{remove} the files, run \texttt{sudo make uninstall}.
\subsection{Add to path for Windows}
To add \texttt{latexindent.exe} to the path for Windows, follow these steps:
\begin{enumerate}
	\item download  \texttt{latexindent.exe}, \texttt{defaultSettings.yaml},  \texttt{add-to-path.bat}
	      from \cite{latexindent-home} to your chosen directory;
	\item open a command prompt and run \texttt{echo %path%} to see what is \emph{currently} in your \texttt{%path%} variable;
	\item right click on \texttt{add-to-path.bat} and \emph{Run as administrator};
	\item log out, and log back in;
	\item open a command prompt and run \texttt{echo %path%} to check that the appropriate directory has been added to your
	      \texttt{%path%}.
\end{enumerate}
To \emph{remove} the directory from your \texttt{%path%}, run \texttt{remove-from-path.bat} as administrator.

\section{Differences from Version 2.1 to 3.0 (and beyond)}
There are a few (small) changes to the interface when comparing Version 2.1 to Version 3.0.
Explicitly, these are:
\begin{description}
	\item[OLD] \texttt{latexindent.pl -o myfile.tex outputfile.tex}
	\item[NEW] \texttt{latexindent.pl -o=outputfile.tex myfile.tex}

	\texttt{latexindent.pl -o outputfile.tex myfile.tex}
\end{description}

\section{The \texttt{-m} switch}\label{sec:m-switch}
\subsection{The phases of \texttt{latexindent.pl}}
latexindent.pl essentially has 3 phases:
\begin{enumerate}
	\item packing, in which code blocks are replaced with unique ids; if the -m switch is active, then during this phase,
	      \begin{itemize}
		      \item line breaks at the beginning of the \emph{body} can be added (BodyStartsOnOwnLine: 1) or removed (BodyStartsOnOwnLine: 0);
		      \item line breaks at the end of the body can be added (see EndStartsOnOwnLine: 1) or removed (see EndStartsOnOwnLine: 0);
		      \item NOTE: let's say that any key (such as, for example, BeginStartsOnOwnLine) is set to 1, and the
		            appropriate <thing> does already begin on its own line and is immediately preceeded by one or more blank line; in this situation,
		            the blank lines will \emph{not} be removed
	      \end{itemize}
	\item indentation, in which white space is added to the begin, body, and end statements;
	\item unpacking, in which unique ids are replaced by their \emph{indented} code blocks; if the -m switch is active, then during this phase,
	      \begin{itemize}
		      \item line breaks before \emph{begin} statements can be added or removed (if BeginStartsOnOwnLine==0);
		      \item line breaks after \emph{end} statements can be removed but \emph{NOT} added (see EndFinishesWithLineBreak).
	      \end{itemize}
\end{enumerate}
With these rules in mind, let's study a few test cases:

\fixthis{go into details about each of the following}
latexindent.pl environments-line-break-conflict.tex -s -t -m -o environments-line-break-conflict-mod1.tex -l=env-conflicts-mod1.yaml
latexindent.pl environments-line-break-conflict-nested.tex -s -t -m -o environments-line-break-conflict-nested-mod-2.tex -l=env-conflicts-mod2.yaml
latexindent.pl environments-line-break-conflict-nested.tex -s -t -m -o environments-line-break-conflict-nested-mod-3.tex -l=env-conflicts-mod3.yaml
environments-first-opt-args.tex, see all of the different examples in test-cases.sh
environments-second-opt-args.tex provides some interesting cases too

removeTrailingWhitespace:
beforeProcessing: 0
afterProcessing: 1

there is a difference between these two, especially when it comes to modifying line breaks.

For example, let's say that you have

%\end{something}****
my text

and you tell latexindent not to finish something with a linebreak; with beforeProcessing set to 0, then you'll receive:

%\end{something}****my text

and if you set beforeProcessing to 1, then you'll receive

%\end{something}my text

The \texttt{\fi} command knows to insert a space, so as to give, for example, \texttt{\fi} text, and avoid things such as \texttt{\fitext}

from yaml

\section{Moving from version 2.* to version 3.*}\label{sec:moving-version}
%# EVERYTHING BELOW HERE IS OBSOLETE IN V3.0  
%# EVERYTHING BELOW HERE IS OBSOLETE IN V3.0  
%# EVERYTHING BELOW HERE IS OBSOLETE IN V3.0  
%# *** NOTE ***
%# If you have specified alwaysLookforSplitBraces: 1
%# and alwaysLookforSplitBrackets: 1 then you don't need
%# to worry about completing
%#
%#       checkunmatched
%#       checkunmatchedELSE
%#       checkunmatchedbracket
%#
%# in other words, you don't really need to edit anything 
%# below this line- it used to be necessary for older 
%# versions of the script, but not anymore :)
%#***      ***
%#
%# always look for split { }, which means that the user doesn't
%# have to complete checkunmatched, checkunmatchedELSE
%
%# if you want to indent if, else, fi constructs such as, for example,
%#
%#       \ifnum#1=2
%#               something
%#       \else
%#               something else
%#       \fi
%#
%# then populate them in constructIfElseFi
%#
%# The following list is by no means exhaustive, but is taken from etex documentation;
%# add your own if commands to your own yaml settings.
%constructIfElseFi:
%    if: 1
%    ifcat: 1
%    ifnum: 1
%    ifdim: 1
%    ifodd: 1
%    ifvmode: 1
%    ifhmode: 1
%    ifmmode: 1
%    ifinner: 1
%    ifvoid: 1
%    ifhbox: 1
%    ifvbox: 1
%    ifx: 1
%    ifeof: 1
%    iftrue: 1
%    ifcase: 1
%    ifdefined: 1
%    ifcsname: 1
%    iffontchar: 1
%
%#noAdditionalIndent:
%#    \[: 0
%#    \]: 0
%
%alwaysLookforSplitBraces: 1
%
%# always look for split [ ], which means that the user doesn't
%# have to complete checkunmatchedbracket
%alwaysLookforSplitBrackets: 1
%
%
%# commands that might split {} across lines
%# such as \parbox, \marginpar, etc
%checkunmatched:
%    parbox: 1
%    vbox: 1
%
%# very similar to %checkunmatched except these 
%# commands might have an else construct
%checkunmatchedELSE:
%    pgfkeysifdefined: 1
%    DTLforeach: 1
%    ifthenelse: 1
%
%# commands that might split []  across lines
%# such as \pgfplotstablecreatecol, etc
%checkunmatchedbracket:
%    pgfplotstablecreatecol: 1
%    pgfplotstablesave: 1
%    pgfplotstabletypeset: 1
%    mycommand: 1
%    psSolid: 1
%
% OLD
%indentAfterHeadings:
%    part:
%       indent: 0
%       level: 1
% NEW:
%indentAfterHeadings:
%    part:
%       indentAfterThisHeading: 0
%       level: 1


\end{document}
