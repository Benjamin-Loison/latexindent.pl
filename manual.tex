% arara: pdflatex
% !arara: indent: {overwrite: yes, trace: yes, localsettings: yes}
\documentclass[11pt]{article}
\usepackage[left=4.5cm,right=2.5cm,showframe=false,
top=2cm,bottom=1.5cm]{geometry}               
\usepackage{parskip}
\usepackage{booktabs}
\usepackage{listings}
\usepackage{titlesec}
\usepackage{xcolor}
\usepackage[sc]{caption}
%\usepackage{kpfonts}
\usepackage[colorlinks=true,linkcolor=blue]{hyperref}
\usepackage{cleveref}


% tex.stackexchange.com/questions/93944/using-lstinline-inside-a-item/
% allow \lstinline inside an \item
% \begin{noindent}
\makeatletter
\let\orig@item\item

\def\item{%
	\@ifnextchar{[}%
		{\lstinline@item}%
		{\orig@item}%
	}
	
	\begingroup
\catcode`\]=\active
\gdef\lstinline@item[{%
		\setbox0\hbox\bgroup
	\catcode`\]=\active
\let]\lstinline@item@end
}
\endgroup

\def\lstinline@item@end{%
	\egroup
	\orig@item[\usebox0]%
}

\makeatother
% \end{noindent}

\lstset{%
	basicstyle=\small\ttfamily,language={[LaTeX]TeX},   
	numbers=left,
	numberstyle=\ttfamily\small,
	breaklines=true,frame=single,framexleftmargin=8mm, xleftmargin=8mm,
	prebreak = \raisebox{0ex}[0ex][0ex]{\ensuremath{\hookrightarrow}},
	backgroundcolor=\color{green!5},frameround=fttt,
	rulecolor=\color{blue!70!black},
	keywordstyle=\color{blue},                    % keywords
	commentstyle=\color{purple},    % comments
	%columns=fullflexible   
}%
% stolen from arara.sty http://mirrors.med.harvard.edu/ctan/support/arara/doc/arara.sty
\lstnewenvironment{yaml}[1][]{\lstset{%
	basicstyle=\ttfamily,
	numbers=left,
	xleftmargin=1.5em,
	breaklines=true,
	numberstyle=\ttfamily\small,
	columns=flexible,
	mathescape=false,
	#1,
	}}{}
\newcommand{\fixthis}[1]
{%
	\marginpar{\huge \color{red} \framebox{FIX}}%
	\typeout{FIXTHIS: p\thepage : #1^^J}%
}
% custom section
\titleformat{\section}
{\normalfont\Large\bfseries}
{\llap{\thesection\hskip.5cm}}
{0pt}
{}
% custom subsection
\titleformat{\subsection}
{\normalfont\bfseries}
{\llap{\thesubsection\hskip.5cm}}
{0pt}
{}

\titlespacing\section{0pt}{12pt plus 4pt minus 2pt}{-5pt plus 2pt minus 2pt}
\titlespacing\subsection{0pt}{12pt plus 4pt minus 2pt}{-6pt plus 2pt minus 2pt}
\titlespacing\subsubsection{0pt}{12pt plus 4pt minus 2pt}{-6pt plus 2pt minus 2pt}


% cleveref settings
\crefname{table}{Table}{Tables}
\Crefname{table}{Table}{Tables}
\crefname{section}{Section}{Sections}
\Crefname{section}{Section}{Sections}
\crefname{lstlisting}{Listing}{Listings}
\Crefname{lstlisting}{Listing}{Listings}

\begin{document}

\title{\lstinline[basicstyle=\huge\ttfamily]!indent.plx!}
\author{Chris Hughes}
\maketitle
\begin{abstract}
 \lstinline!indent.plx! is a \lstinline!Perl! script that indents \lstinline!.tex!
 files according to an indentation scheme that the user can modify to suit their 
 taste. Environments, including those with alignment delimiters (such as \lstinline!tabular!), 
 commands, including those that can split braces and brackets across lines, 
 are \emph{usually} handled correctly by the script.
\end{abstract}

\tableofcontents
\lstlistoflistings

\section{Before we begin}
I first created \lstinline!indent.plx! for helping me to format chapter files 
in a big project that I am working on. After I blogged about it on the 
\TeX{} stack exchange \cite{cmhblog}\fixthis{citation} I received some positive feedback and 
follow-up feature requests. A big thank you to Harish Kumar who has really 
helped to drive the script forward and has put it through a number of challenging
tests-- I look forward to more challenges in the future Harish!

\lstinline!indent.plx! has the option to overwrite your \lstinline!.tex! files.
It will always make at least one backup (you can choose how many it makes, see \cpageref{page:onlyonebackup})
but you should still be careful when using it. The script has been tested on many
files, but there are some known limitations (see \cref{sec:knownlimitations}). You, 
the user, are responsible for ensuring that you maintain backups of your files
before running \lstinline!indent.plx! on them. I think it is important at this
stage to restate an important part of the license here:
\begin{quote}\itshape
This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
\end{quote}
There is certainly no malicious intent in releasing this script, and I do hope
that it works as you expect it to-- if it does not, please first of all 
make sure that you have the correct settings, and then let me know with a 
complete minimum working example as I would like to improve the code as much as possible. 

\section{Demonstration: before and after}

\section{How to use the script}
There are two ways to use \lstinline!indent.plx!: from the command line, 
and using \lstinline!arara!.  We will discuss how to change the settings and behaviour 
of the script in \cref{sec:defuseloc}.

\subsection{From the command line}\label{sec:commandline}
\lstinline!indent.plx! has a number of different switches/flags/options, which 
can be combined in any way that you like. \lstinline!indent.plx! 
produces a \lstinline!.log! file, \lstinline!indent.log! every time it
is run. There is a base of information that is written to \lstinline!indent.log!,
but other additional information will be written depending 
on which of the following options are used.
\begin{itemize}
	\item[] \lstinline!indent.plx myfile.tex!
	
	This will simply output to your terminal; \lstinline!myfile.tex! will
	not be changed in any way using this command. 
	\item[\lstinline!-w!] \lstinline!indent.plx -w myfile.tex!
	
	This \emph{will} overwrite \lstinline!myfile.tex!, but it will
	make a copy of \lstinline!myfile.tex! first. You can control the name of 
	the extension (default is \lstinline!.bak!), and how many different backups are made-- 
	more on this in \cref{sec:defuseloc}; see \lstinline!backupExtension! and \lstinline!onlyOneBackUp!.
	\item[\lstinline!-o!] \lstinline!indent.plx -o myfile.tex outputfile.tex!
	
	This will indent \lstinline!myfile.tex! and output it to \lstinline!outputfile.tex!, 
	overwriting it (\lstinline!outputfile.tex!) if it already exists. Note that if \lstinline!indent.plx! is called with both
	the \lstinline!-w! and \lstinline!-o! switches, then \lstinline!-w! will
	be ignored and \lstinline!-o! will take priority (this seems safer than the 
	other way round).
	
	Note that using \lstinline!-o! is equivalent to using \lstinline!indent.plx myfile.tex > outputfile.tex!
	\item[\lstinline!-s!] \lstinline!indent.plx -s myfile.tex!
	
	Silent mode: no output will be given to the terminal.
	\item[\lstinline!-t!] \lstinline!indent.plx -t myfile.tex!
	
	Tracing mode: verbose output will be given to \lstinline!indent.log!. This 
	is useful if \lstinline!indent.plx! has made a mistake and you're
	trying to find out where and why.
	\item[\lstinline!-l!] \lstinline!indent.plx -l myfile.tex!
	
      \label{page:localswitch}
	Local settings: you might like to read \cref{sec:defuseloc} before 
	using this switch. \lstinline!indent.plx! will always load \lstinline!defaultSettings.yaml!
	and if it is called with the \lstinline!-l! switch and it finds \lstinline!localSettings.yaml! 
	in the same directory as \lstinline!myfile.tex! then these settings will be 
	added to the indentation scheme.
\end{itemize}
\subsection{From \lstinline!arara!}
Using \lstinline!indent.plx! from the command line is fine for some folks, but
others may find it easier to use from \lstinline!arara!. \lstinline!indent.plx!
ships with an \lstinline!arara! rule, \lstinline!indent.yaml!, which you can either copy it to the directory of
your other \lstinline!arara! rules, or otherwise add the \lstinline!indent.plx!
directory to your \lstinline!araraconfig.yaml! file.

Once you have told \lstinline!arara! where to find your \lstinline!indent! rule, 
you can use it any of the following ways (or combinations thereof). 

\begin{lstlisting}[caption={\lstinline!arara! samples},escapeinside={(*@}{@*)}]
%(*@@*) arara: indent
%(*@@*) arara: indent: {overwrite: yes}
%(*@@*) arara: indent: {output: myfile.tex}
%(*@@*) arara: indent: {silent: yes}
%(*@@*) arara: indent: {trace: yes}
%(*@@*) arara: indent: {localsettings: yes}
\documentclass{article}
...
\end{lstlisting}

Hopefully the use of these rules is fairly self-explanatory, but for completeness
\cref{tab:orbsandswitches} shows the relationship between \lstinline!arara! orb-tags and the 
switches given in \cref{sec:commandline}.

\begin{table}[!ht]
	\centering
	\caption{\lstinline!arara! orb tags and corresponding switches}
	\label{tab:orbsandswitches}
	\begin{tabular}{lc}
		\toprule
		\lstinline!arara! orb tags & switch         \\
		\midrule
		\lstinline!overwrite!      & \lstinline!-w! \\
		\lstinline!output!         & \lstinline!-o! \\
		\lstinline!silent!         & \lstinline!-s! \\
		\lstinline!trace!          & \lstinline!-t! \\
		\lstinline!localsettings!  & \lstinline!-l! \\
		\bottomrule
	\end{tabular}
\end{table}
\section{default, user, and local settings}\label{sec:defuseloc}
\lstinline!indent.plx! loads its settings from \lstinline!defaultSettings.yaml! 
(rhymes with camel). The idea is to separate the behaviour of the script 
from the internal working-- this is very similar to the way that we separate content
from form when writing our documents in \LaTeX.


\subsection{\lstinline!defaultSettings.yaml!}
If you look in \lstinline!defaultSettings.yaml! you'll find the switches 
that govern the behaviour of \lstinline!indent.plx!. The code is commented, 
but here is a description of what each switch is designed to do. The default 
value is given in each case.

You can certainly feel free to edit \lstinline!defaultSettings.yaml!, but 
this is not ideal as it may be overwritten when you update your distribution--
all of your hard work tweaking the script would be undone! Don't worry, 
there's a solution-- feel free to peek ahead to \cref{sec:indentconfig} if you like.
\begin{itemize}
	\item[\lstinline!defaultindent!] \lstinline!"\t"!
	
	This is the default indentation (\lstinline!\t! means a tab) used in the absence of other details 
	for the command or environment we are working with-- see \lstinline!indentrules!
	for more details (\cpageref{page:indentrules}).
	\item[\lstinline!backupExtension!] \lstinline!.bak!
	
	If you call \lstinline!indent.plx! with the \lstinline!-w! switch (to overwrite
	\lstinline!myfile.tex!) then it will create a backup file before doing 
	any indentation: \lstinline!myfile.bak0! 
	
	By default, every time you call \lstinline!indent.plx! after this with 
	the \lstinline!-w! switch it will create \lstinline!myfile.bak1!, \lstinline!myfile.bak2!, 
	etc.
	\item[\lstinline!onlyOneBackUp!] \lstinline!0!
	
      \label{page:onlyonebackup}
	If you don't want a backup for every time that you call \lstinline!indent.plx! (so 
	you don't want \lstinline!myfile.bak1!, \lstinline!myfile.bak2!, etc) and you simply
	want \lstinline!myfile.bak! (or whatever you chose \lstinline!backupExtension! to be)
	then change \lstinline!onlyOneBackUp! to \lstinline!1!.
	\item[\lstinline!indentPreamble!] \lstinline!0!
	
	The preamble of a document can sometimes contain some trickier code 
	for \lstinline!indent.plx! to work with. By default, \lstinline!indent.plx!
	won't try to operate on the preamble, but if you'd like it to try then 
	change \lstinline!indentPreamble! to \lstinline!1!.
	\item[\lstinline!alwaysLookforSplitBraces!] \lstinline!1!
	
	This switch tells \lstinline!indent.plx! to look for commands that 
	can split \emph{braces} across lines, such as \lstinline!parbox!, \lstinline!tikzset!, etc. In older
	versions of \lstinline!indent.plx! you had to specify each one in \lstinline!checkunmatched!-- this 
	clearly became tedious, hence the introduction of \lstinline!alwaysLookforSplitBraces!. 
	
	\emph{As long as you leave this switch on (set to 1) you don't need to specify which 
    commands can split braces across lines-- you can ignore the 
    fields \lstinline!checkunmatched! and \lstinline!checkunmatchedELSE! described later}.
	\item[\lstinline!alwaysLookforSplitBrackets!] \lstinline!1!
	
	This switch tells \lstinline!indent.plx! to look for commands that 
	can split \emph{brackets} across lines, such as \lstinline!psSolid!, \lstinline!pgfplotstabletypeset!, 
	etc. In older versions of \lstinline!indent.plx! you had to specify each one in \lstinline!checkunmatchedbracket!-- 
	this clearly became tedious, hence the introduction of \lstinline!alwaysLookforSplitBraces!. 
	
	\emph{As long as you leave this switch on (set to 1) you don't need to specify which 
	commands can split brackets across lines-- you can ignore \lstinline!checkunmatchedbracket! described later}.
	
	\item[\lstinline!lookforaligndelims!] This is the first example of a field
	in \lstinline!defaultSettings.yaml! that has more than one line; \cref{lst:aligndelims}
	shows more details.
	
	\begin{yaml}[caption={\lstinline!lookforaligndelims!},label={lst:aligndelims}]
lookforaligndelims:
   tabular: 1
   align: 1
   align*: 1
   alignat: 1
   alignat*: 1
   cases: 1
   dcases: 1
   aligned: 1
   pmatrix: 1
   listabla: 1
		\end{yaml}
	
	You can populate this field with any other environments that you have that contain \lstinline!&!. 
	If you change your mind, just turn them off by setting them to \lstinline!0! instead.
	
	\item[\lstinline!verbatimEnvironments!] A field that contains a list of environments
	that you would like left completely alone-- no indentation will be done
	to environments that you have specified in this field-- see \cref{lst:verbatimEnvironments}.
	
	\begin{yaml}[caption={\lstinline!verbatimEnvironments!},label={lst:verbatimEnvironments}]
verbatimEnvironments:
    verbatim: 1
    lstlisting: 1
		\end{yaml}
	
	\item[\lstinline!noindentblock!] If you have a block of code that you don't 
	want \lstinline!indent.plx! to touch (even if it is \emph{not} a verbatim-like
	environment) then you can wrap it in an environment from \lstinline!noindentblock!;
	you can use any name you like for this, provided you populate it as demonstrate in 
	\cref{lst:noindentblock}.
	
	\begin{yaml}[caption={\lstinline!noindentblock!},label={lst:noindentblock}]
noindentblock:
    noindent: 1
    cmhtest: 1
		\end{yaml}
	
	Of course, you don't want to have to specify these as null environments
	in your code, so you use them with a comment symbol, \lstinline!%!, as demonstrated in \cref{lst:noindentblockdemo}
	\begin{lstlisting}[caption={\lstinline!noindentblock! demonstration},label={lst:noindentblockdemo},escapeinside={(*@}{@*)}]
%(*@@*) \begin{noindent} 
        this code
                won't be touched
        by \lstinline!indent.plx!
%(*@@*) \end{noindent} 
		    \end{lstlisting}
	
	\item[\lstinline!noAdditionalIndent!] If you would prefer some of your
	environments or commands not to receive any additional indent, then 
	populate \lstinline!noAdditionalIndent!; see \cref{lst:noAdditionalIndent}. 
	Note that these environments will still receive the \emph{current} level
	of indentation unless they belong to \lstinline!verbatimEnvironments!, or \lstinline!noindentblock!.
	
	\begin{yaml}[caption={\lstinline!noAdditionalIndent!},label={lst:noAdditionalIndent}]
noAdditionalIndent:
    document: 1
    pccexample: 1
    pccdefinition: 1
    problem: 1
    exercises: 1
    pccsolution: 1
    foreach: 0
    widepage: 1
    comment: 1
    \[: 0
    frame: 0
		  \end{yaml}
	
	\item[\lstinline!indentrules!] If\label{page:indentrules} you would prefer to specify 
	individual rules for certain environments or commands, just
	populate \lstinline!indentrules!; see \cref{lst:indentrules}
	
	\begin{yaml}[caption={\lstinline!indentrules!},label={lst:indentrules}]
indentrules:
   myenvironment: "\t\t"
   anotherenvironment: "\t\t\t\t"
   \[: "\t"
		\end{yaml}
	
	\item[\color{red}\bfseries!!!] \emph{The following fields are marked in red, as they are not necessary
	unless you wish to micro manage your indentation scheme.}
	
	% to anyone reading the source code- I know the next line isn't the
	% correct way to do it :)
	\item[\color{red}\lstinline!checkunmatched!] Assuming you keep \lstinline!alwaysLookforSplitBraces! set to \lstinline!1! (which
	is the default) then you don't need to worry about \lstinline!checkunmatched!. 
	
	Should you wish to deactivate \lstinline!alwaysLookforSplitBraces! by setting it to \lstinline!0!, then 
	you can populate \lstinline!checkunmatched! with commands that can split braces across 
	lines-- see \cref{lst:checkunmatched}.
	
	\begin{yaml}[caption={\lstinline!checkunmatched!},label={lst:checkunmatched}]
checkunmatched:
    parbox: 1
    vbox: 1
		\end{yaml}
	\item[\color{red}\lstinline!checkunmatchedELSE!] Similarly, assuming you keep \lstinline!alwaysLookforSplitBraces! set to \lstinline!1! (which
	is the default) then you don't need to worry about \lstinline!checkunmatchedELSE!. 
	
	As in \lstinline!checkunmatched!, should you wish to deactivate \lstinline!alwaysLookforSplitBraces! by setting it to \lstinline!0!, then 
	you can populate \lstinline!checkunmatchedELSE! with commands that can split braces across 
	lines \emph{and} have an `else' statement-- see \cref{lst:checkunmatchedELSE}.
	
	\begin{yaml}[caption={\lstinline!checkunmatchedELSE!},label={lst:checkunmatchedELSE}]
checkunmatchedELSE:
    pgfkeysifdefined: 1
    DTLforeach: 1
    ifthenelse: 1
		\end{yaml}
	\item[\color{red}\lstinline!checkunmatchedbracket!] Assuming you keep \lstinline!alwaysLookforSplitBrackets! 
	set to \lstinline!1! (which is the default) then you don't need to worry about \lstinline!checkunmatchedbracket!. 
	
	Should you wish to deactivate \lstinline!alwaysLookforSplitBrackets! by setting it 
	to \lstinline!0!, then you can populate \lstinline!checkunmatchedbracket! with commands that can 
	split \emph{brackets} across lines-- see \cref{lst:checkunmatchedbracket}.
	
	\begin{yaml}[caption={\lstinline!checkunmatchedbracket!},label={lst:checkunmatchedbracket}]
checkunmatchedbracket:
    psSolid: 1
    pgfplotstablecreatecol: 1
    pgfplotstablesave: 1
    pgfplotstabletypeset: 1
    mycommand: 1
		\end{yaml}
\end{itemize}


\subsection{\lstinline!indentconfig.yaml! (for user settings)}\label{sec:indentconfig}
A better way to change the settings is to set up your own settings file, 
\lstinline!mysettings.yaml! (or any name you like, provided it ends with \lstinline!.yaml!). 
The only thing you have to do is tell \lstinline!indent.plx! where to find it. 

\lstinline!indent.plx! will always check your home directory for \lstinline!indentconfig.yaml!, 
which is a plain text file you can create that contains the \emph{absolute}
paths for any settings files that you wish \lstinline!indent.plx! to load-- see
\cref{lst:indentconfig} for a sample.

\begin{yaml}[caption={\lstinline!indentconfig.yaml!},label={lst:indentconfig}]
# Paths to user settings for indent.plx
#
# Note that the settings will be read in the order you 
# specify here- each successive settings file will overwrite
# the variables that you specify

paths:
- /home/cmhughes/Documents/yamlfiles/mysettings.yaml
- /home/cmhughes/folder/othersettings.yaml
- /some/other/folder/anynameyouwant.yaml
\end{yaml}

Note that the \lstinline!.yaml! files you specify in \lstinline!indentconfig.yaml!
will be loaded in the order that you write them in. Each file doesn't have 
to have every switch from \lstinline!defaultSettings.yaml!; in fact, I recommend 
that you only keep the switches that you want to \emph{change} in your 
settings files.

To get started with your own settings file, you might like to save a copy of 
\lstinline!defaultSettings.yaml! in another directory and call it, for 
example, \lstinline!mysettings.yaml!. Once you have added the path to \lstinline!indentconfig.yaml!
feel free to start changing the switches and adding more environments to it 
as you see fit-- have a look at \cref{lst:mysettings} for an example 
that uses four tabs for the default indent, and adds the \lstinline!tabbing!
environment to the list of environments that contains alignment delimiters.

\begin{yaml}[caption={\lstinline!mysettings.yaml! (example)},label={lst:mysettings}]
# Default value of indentation
defaultindent: "\t\t\t\t"

# environments that have tab delimiters, add more 
# as needed
lookforaligndelims:
   tabbing: 1
\end{yaml}

You can make sure that your settings are loaded by checking \lstinline!indent.log!
for details-- if you have specified a path that \lstinline!indent.plx! doesn't 
recognize then you'll get a warning, otherwise you'll get confirmation that 
\lstinline!indent.plx! has read your settings file.

\fixthis{need Windows setup}

\subsection{localSettings.yaml}
You may remember on \cpageref{page:localswitch} we discussed the \lstinline!-l! switch
that tells \lstinline!indent.plx! to look for \lstinline!localSettings.yaml! in the 
\emph{same directory} as \lstinline!myfile.tex!. This settings file will 
be read \emph{after} \lstinline!defaultSettings.yaml! and, assuming they exist, 
user settings. 

In contrast to the \emph{user} settings which can be named anything you like (provided that
they are detailed in \lstinline!indentconfig.yaml!), the \emph{local} settings file
must be called \lstinline!localSettings.yaml!. It can contain any switches that you'd
like to change-- a sample is shown in \cref{lst:localsettings}.

\begin{yaml}[caption={\lstinline!localSettings.yaml! (example)},label={lst:localsettings}]
# Default value of indentation
defaultindent: " "

# environments that have tab delimiters, add more 
# as needed
lookforaligndelims:
   tabbing: 0

#  verbatim environments- environments specified 
#  in this hash table will not be changed at all!
verbatimEnvironments:
    cmhenvironment: 0
\end{yaml}

You can make sure that your local settings are loaded by checking \lstinline!indent.log!
for details-- if \lstinline!localSettings.yaml! can not be read then you will
get a warning, otherwise you'll get confirmation that 
\lstinline!indent.plx! has read \lstinline!localSettings.yaml!.

\subsection{Settings load order}
\lstinline!indent.plx! loads the settings files in the following order:
\begin{enumerate}
	\item \lstinline!defaultSettings.yaml! (always loaded, can not be renamed)
	\item \lstinline!anyUserSettings.yaml! (and any other arbitrarily-named files specified in \lstinline!indentconfig.yaml!)
	\item \lstinline!localSettings.yaml! (if found in same directory as \lstinline!myfile.tex! and called
	with \lstinline!-l! switch; can not be renamed)
\end{enumerate}

\section{Known limitations}\label{sec:knownlimitations}
nested align delimiter blocks
tables with multicolumn
\end{document}
